use std::arch::x86_64::*;
use crate::field::fields::*;
use crate::ntt::transpose::*;

#[target_feature(enable = "avx2")]
pub unsafe fn ntt_7681(s0: [__m256i;16]) -> [__m256i;16]{
    let s1 = ntt1234_7681(s0);
    let s2 = transpose(s1);
    let s3 = ntt5678_7681(s2);
    s3
}

#[target_feature(enable = "avx2")]
pub unsafe fn ntt1234_7681(a: [__m256i;16]) -> [__m256i;16]{
    let mut a0: [__m256i;16] = [_mm256_setzero_si256(); 16];
    let mut a1: [__m256i;16] = [_mm256_setzero_si256(); 16];
    // let l1 ~ l4
    let l1:[__m256i;2] = [_mm256_set1_epi16(3383), _mm256_set1_epi16(28865)];
    let l2:[__m256i;4] = [_mm256_set1_epi16(1925), _mm256_set1_epi16(16425), _mm256_set1_epi16(1213), _mm256_set1_epi16(10350)];
    let l3:[__m256i;8] = [_mm256_set1_epi16(583), _mm256_set1_epi16(4974), _mm256_set1_epi16(1728), _mm256_set1_epi16(14744), _mm256_set1_epi16(527), _mm256_set1_epi16(4496), _mm256_set1_epi16(849), _mm256_set1_epi16(7244)];
    let l4:[__m256i;16] = [_mm256_set1_epi16(2381), _mm256_set1_epi16(20315), _mm256_set1_epi16(2446), _mm256_set1_epi16(20870), _mm256_set1_epi16(97), _mm256_set1_epi16(828), _mm256_set1_epi16(2132), _mm256_set1_epi16(18191), _mm256_set1_epi16(2784), _mm256_set1_epi16(23754), _mm256_set1_epi16(1366), _mm256_set1_epi16(11655), _mm256_set1_epi16(2138), _mm256_set1_epi16(18242), _mm256_set1_epi16(2648), _mm256_set1_epi16(22593)];

    // Layer 1
    for i in 0..8{
        [a0[i], a0[i+8]] = barrett_butterfly_7681(a[i], a[i+8], l1[0], l1[1]);
    }
    // Layer 2
    for i in 0..4{
        [a1[i], a1[i+4]] = barrett_butterfly_7681(a0[i], a0[i+4], l2[0], l2[1]);
        [a1[i+8], a1[i+12]] = barrett_butterfly_7681(a0[i+8], a0[i+12], l2[2], l2[3]);
    }
    // Layer 3
    for i in 0..4{
        for j in 0..2{
            [a0[i*4+j], a0[i*4+j+2]] = barrett_butterfly_7681(a1[i*4+j], a1[i*4+j+2], l3[2*i], l3[2*i+1]);
        }
    }
    // Layer 4
    for i in 0..8{
        [a1[i*2], a1[i*2+1]] = barrett_butterfly_7681(a0[i*2], a0[i*2+1], l4[2*i], l4[2*i+1]);
    }
    a1
}

#[target_feature(enable = "avx2")]
pub unsafe fn ntt5678_7681(a: [__m256i;16]) -> [__m256i;16]{
    let mut a0: [__m256i;16] = [_mm256_setzero_si256(); 16];
    let mut a1: [__m256i;16] = [_mm256_setzero_si256(); 16];
    // let l5 ~ l8
    let l5:[__m256i;2] = [_mm256_set_epi16(1846, 365, 2753, 3654, 2645, 330, 2273, 878, 3000, 2399, 1112, 1794, 2268, 675, 3092, 1286), _mm256_set_epi16(15750, 3114, 23489, 31177, 22568, 2816, 19394, 7491, 25597, 20469, 9488, 15307, 19351, 5759, 26382, 10972)];
    let l6:[__m256i;4] = [_mm256_set_epi16(3074, 3080, 3380, 1714, 2423, 2724, 1381, 799, 766, 202, 2516, 2551, 528, 2941, 584, 1740), _mm256_set_epi16(26228, 26279, 28839, 14624, 20674, 23242, 11783, 6817, 6536, 1724, 21467, 21766, 4505, 25093, 4983, 14846), _mm256_set_epi16(732, 3477, 2469, 693, 1382, 1908, 1875, 695, 2881, 243, 1080, 3411, 3449, 2508, 1655, 2774), _mm256_set_epi16(6246, 29667, 21066, 5913, 11792, 16279, 15998, 5930, 24581, 2073, 9215, 29103, 29428, 21399, 14121, 23668)];
    let l7:[__m256i;8] = [_mm256_set_epi16(3125, 1478, 3073, 2563, 869, 405, 3188, 198, 1408, 1853, 1682, 3099, 1952, 550, 707, 3780), _mm256_set_epi16(26663, 12611, 26220, 21868, 7415, 3456, 27201, 1689, 12013, 15810, 14351, 26441, 16655, 4693, 6032, 32252), _mm256_set_epi16(2819, 257, 3566, 1220, 1996, 2897, 880, 1587, 1044, 1003, 1415, 648, 2044, 1848, 2990, 1125), _mm256_set_epi16(24052, 2193, 30426, 10409, 17030, 24718, 7508, 13541, 8908, 8558, 12073, 5529, 17440, 15768, 25511, 9599), _mm256_set_epi16(3789, 3141, 2264, 1886, 1633, 319, 219, 2063, 993, 2844, 3532, 3078, 2028, 1228, 1438, 2593), _mm256_set_epi16(32329, 26800, 19317, 16092, 13933, 2722, 1869, 17602, 8472, 24266, 30136, 26262, 17303, 10478, 12269, 22124), _mm256_set_epi16(1402, 3180, 1155, 2573, 1800, 3837, 3501, 2900, 2722, 3041, 2880, 2562, 1591, 1097, 2681, 417), _mm256_set_epi16(11962, 27132, 9855, 21953, 15358, 32738, 29871, 24743, 23225, 25946, 24573, 21860, 13575, 9360, 22875, 3558)];
    let l8:[__m256i;16] = [_mm256_set_epi16(296, 1876, 3452, 506, 2875, 1950, 321, 1704, 3137, 2067, 1170, 536, 3016, 2840, 329, 3765), _mm256_set_epi16(2526, 16006, 29453, 4317, 24530, 16638, 2739, 14539, 26766, 17636, 9983, 4573, 25733, 24232, 2807, 32124), _mm256_set_epi16(2838, 2002, 2996, 1065, 1979, 1129, 2922, 3799, 2671, 2951, 2395, 572, 2760, 1211, 738, 1897), _mm256_set_epi16(24214, 17082, 25563, 9087, 16885, 9633, 24931, 32414, 22790, 25179, 20435, 4880, 23549, 10333, 6297, 16186), _mm256_set_epi16(1406, 2012, 1035, 702, 201, 2259, 3445, 413, 1459, 217, 1775, 2717, 2252, 1872, 3483, 3250), _mm256_set_epi16(11996, 17167, 8831, 5990, 1715, 19274, 29394, 3524, 12449, 1851, 15145, 23182, 19215, 15972, 29718, 27730), _mm256_set_epi16(1959, 1230, 1131, 1437, 3626, 398, 2358, 763, 3086, 3265, 1717, 2546, 1036, 3832, 335, 3239), _mm256_set_epi16(16715, 10495, 9650, 12261, 30938, 3396, 20119, 6510, 26330, 27858, 14650, 21723, 8839, 32695, 2858, 27636), _mm256_set_epi16(2169, 2197, 1193, 542, 1607, 3546, 1656, 669, 2050, 3615, 1657, 1725, 535, 639, 218, 1771), _mm256_set_epi16(18506, 18745, 10179, 4624, 13711, 30255, 14129, 5708, 17491, 30844, 14138, 14718, 4565, 5452, 1860, 15111), _mm256_set_epi16(2372, 2757, 3394, 2173, 1667, 1604, 2799, 2668, 793, 1393, 1499, 1885, 2811, 3376, 118, 113), _mm256_set_epi16(20238, 23523, 28958, 18541, 14223, 13686, 23882, 22764, 6766, 11885, 12790, 16083, 23984, 28805, 1007, 964), _mm256_set_epi16(3586, 3006, 94, 3120, 1968, 2359, 185, 2689, 1784, 856, 2481, 3193, 621, 674, 2805, 1189), _mm256_set_epi16(30597, 25648, 802, 26621, 16791, 20128, 1578, 22943, 15221, 7304, 21168, 27243, 5299, 5751, 23933, 10145), _mm256_set_epi16(3139, 346, 3081, 1266, 1683, 62, 3694, 2583, 1994, 111, 2110, 2433, 3751, 1115, 3280, 2457), _mm256_set_epi16(26783, 2952, 26288, 10802, 14360, 529, 31518, 22039, 17013, 947, 18003, 20759, 32004, 9513, 27986, 20964)];

    // Layer 5
    for i in 0..8{
        [a0[i], a0[i+8]] = barrett_butterfly_7681(a[i], a[i+8], l5[0], l5[1]);
    }
    // Layer 6
    for i in 0..4{
        [a1[i], a1[i+4]] = barrett_butterfly_7681(a0[i], a0[i+4], l6[0], l6[1]);
        [a1[i+8], a1[i+12]] = barrett_butterfly_7681(a0[i+8], a0[i+12], l6[2], l6[3]);
    }
    // Layer 7
    for i in 0..4{
        for j in 0..2{
            [a0[i*4+j], a0[i*4+j+2]] = barrett_butterfly_7681(a1[i*4+j], a1[i*4+j+2], l7[2*i], l7[2*i+1]);
        }
    }
    // Layer 8
    for i in 0..8{
        [a1[i*2], a1[i*2+1]] = barrett_butterfly_7681(a0[i*2], a0[i*2+1], l8[2*i], l8[2*i+1]);      
    }
    a1
}

#[target_feature(enable = "avx2")]
pub unsafe fn ntt_10753(s0: [__m256i;16]) -> [__m256i;16]{
    let s1 = ntt1234_10753(s0);
    let s2 = transpose(s1);
    let s3 = ntt5678_10753(s2);
    s3
}

#[target_feature(enable = "avx2")]
pub unsafe fn ntt1234_10753(a: [__m256i;16]) -> [__m256i;16]{
    let mut a0: [__m256i;16] = [_mm256_setzero_si256(); 16];
    let mut a1: [__m256i;16] = [_mm256_setzero_si256(); 16];
    // let l1 ~ l4
    let l1:[__m256i;2] = [_mm256_set1_epi16(4489), _mm256_set1_epi16(27359)];
    let l2:[__m256i;4] = [_mm256_set1_epi16(67), _mm256_set1_epi16(408), _mm256_set1_epi16(321), _mm256_set1_epi16(1956)];
    let l3:[__m256i;8] = [_mm256_set1_epi16(3422), _mm256_set1_epi16(20856), _mm256_set1_epi16(4679), _mm256_set1_epi16(28517), _mm256_set1_epi16(1656), _mm256_set1_epi16(10093), _mm256_set1_epi16(3461), _mm256_set1_epi16(21094)];
    let l4:[__m256i;16] = [_mm256_set1_epi16(1560), _mm256_set1_epi16(9508), _mm256_set1_epi16(2637), _mm256_set1_epi16(16072), _mm256_set1_epi16(4631), _mm256_set1_epi16(28224), _mm256_set1_epi16(3010), _mm256_set1_epi16(18345), _mm256_set1_epi16(2640), _mm256_set1_epi16(16090), _mm256_set1_epi16(1154), _mm256_set1_epi16(7033), _mm256_set1_epi16(4832), _mm256_set1_epi16(29449), _mm256_set1_epi16(2047), _mm256_set1_epi16(12476)];

    // Layer 1
    for i in 0..8{
        [a0[i], a0[i+8]] = barrett_butterfly_10753(a[i], a[i+8], l1[0], l1[1]);
    }
    // Layer 2
    for i in 0..4{
        [a1[i], a1[i+4]] = barrett_butterfly_10753(a0[i], a0[i+4], l2[0], l2[1]);
        [a1[i+8], a1[i+12]] = barrett_butterfly_10753(a0[i+8], a0[i+12], l2[2], l2[3]);
    }
    // Layer 3
    for i in 0..4{
        for j in 0..2{
            [a0[i*4+j], a0[i*4+j+2]] = barrett_butterfly_10753(a1[i*4+j], a1[i*4+j+2], l3[2*i], l3[2*i+1]);
        }
    }
    // Layer 4
    for i in 0..8{
        [a1[i*2], a1[i*2+1]] = barrett_butterfly_10753(a0[i*2], a0[i*2+1], l4[2*i], l4[2*i+1]);     
    }
    a1
}

#[target_feature(enable = "avx2")]
pub unsafe fn ntt5678_10753(a: [__m256i;16]) -> [__m256i;16]{
    let mut a0: [__m256i;16] = [_mm256_setzero_si256(); 16];
    let mut a1: [__m256i;16] = [_mm256_setzero_si256(); 16];
    // let l5 ~ l8
    let l5:[__m256i;2] = [_mm256_set_epi16(1186, 1219, 4351, 4191, 3783, 2900, 746, 4611, 136, 2417, 644, 1641, 1917, 3013, 2436, 597), _mm256_set_epi16(7228, 7429, 26518, 25543, 23056, 17675, 4547, 28103, 829, 14731, 3925, 10001, 11683, 18363, 14847, 3639)];
    let l6:[__m256i;4] = [_mm256_set_epi16(3171, 2603, 3712, 1385, 3314, 3775, 3697, 380, 1136, 946, 559, 3362, 2599, 2085, 2744, 922), _mm256_set_epi16(19326, 15864, 22623, 8441, 20198, 23007, 22532, 2316, 6924, 5766, 3407, 20490, 15840, 12707, 16724, 5619), _mm256_set_epi16(2353, 3644, 3982, 2031, 5147, 753, 3954, 3907, 2582, 841, 3902, 5194, 94, 4455, 5122, 1047), _mm256_set_epi16(14341, 22209, 24269, 12378, 31369, 4589, 24098, 23812, 15736, 5126, 23781, 31656, 573, 27152, 31217, 6381)];
    let l7:[__m256i;8] = [_mm256_set_epi16(118, 3719, 317, 1279, 1896, 159, 721, 4825, 5012, 1943, 1266, 5155, 1353, 4577, 1924, 2857), _mm256_set_epi16(719, 22666, 1932, 7795, 11555, 969, 4394, 29407, 30546, 11842, 7716, 31418, 8246, 27895, 11726, 17412), _mm256_set_epi16(2805, 4818, 3617, 671, 5232, 4053, 84, 2883, 3592, 1444, 5263, 339, 1828, 2830, 2177, 3256), _mm256_set_epi16(17096, 29364, 22044, 4090, 31887, 24702, 512, 17571, 21892, 8801, 32076, 2066, 11141, 17248, 13268, 19844), _mm256_set_epi16(5134, 216, 4980, 331, 2004, 2726, 5295, 393, 2461, 29, 1202, 1207, 4193, 5178, 4683, 3092), _mm256_set_epi16(31290, 1316, 30351, 2017, 12214, 16614, 32271, 2395, 14999, 177, 7326, 7356, 25555, 31558, 28541, 18845), _mm256_set_epi16(2847, 1854, 267, 1945, 4305, 100, 5125, 685, 4098, 1145, 2228, 1289, 4627, 3944, 128, 2135), _mm256_set_epi16(17352, 11300, 1627, 11854, 26238, 609, 31235, 4175, 24976, 6978, 13579, 7856, 28200, 24037, 780, 13012)];
    let l8:[__m256i;16] = [_mm256_set_epi16(3992, 2545, 549, 3942, 4864, 2351, 5096, 3293, 3429, 1445, 3789, 3911, 3258, 301, 697, 2215), _mm256_set_epi16(24330, 15511, 3346, 24025, 29644, 14329, 31058, 20070, 20899, 8807, 23093, 23836, 19856, 1834, 4248, 13500), _mm256_set_epi16(5163, 4819, 2024, 3800, 4847, 4946, 4313, 3098, 5238, 2546, 2425, 3170, 1082, 3689, 290, 3390), _mm256_set_epi16(31467, 29370, 12336, 23160, 29541, 30144, 26286, 18881, 31924, 15517, 14780, 19320, 6594, 22483, 1767, 20661), _mm256_set_epi16(1361, 283, 4524, 3472, 2159, 3778, 1360, 5182, 3930, 38, 1180, 3965, 2777, 156, 3687, 1317), _mm256_set_epi16(8295, 1725, 27572, 21161, 13158, 23026, 8289, 31583, 23952, 232, 7192, 24165, 16925, 951, 22471, 8027), _mm256_set_epi16(1825, 1533, 4181, 4711, 3298, 1961, 2664, 3259, 3903, 1466, 4209, 2670, 3226, 1339, 2076, 2137), _mm256_set_epi16(11123, 9343, 25482, 28712, 20100, 11952, 16236, 19863, 23788, 8935, 25652, 16273, 19661, 8161, 12653, 13024), _mm256_set_epi16(1293, 656, 4861, 3223, 5308, 3210, 2854, 1437, 2515, 4999, 2966, 2056, 2758, 264, 3661, 1267), _mm256_set_epi16(7880, 3998, 29626, 19643, 32351, 19564, 17394, 8758, 15328, 30467, 18077, 12531, 16809, 1609, 22313, 7722), _mm256_set_epi16(2343, 1538, 3192, 5262, 1036, 670, 4783, 1107, 815, 1000, 2160, 3310, 3959, 2266, 3645, 774), _mm256_set_epi16(14280, 9374, 19454, 32070, 6314, 4083, 29151, 6747, 4967, 6095, 13164, 20173, 24129, 13811, 22215, 4717), _mm256_set_epi16(607, 940, 1196, 881, 4894, 10, 2336, 498, 3543, 1590, 4931, 4043, 1985, 1280, 3104, 1907), _mm256_set_epi16(3699, 5729, 7289, 5369, 29827, 61, 14237, 3035, 21593, 9691, 30053, 24641, 12098, 7801, 18918, 11623), _mm256_set_epi16(4314, 4484, 3097, 2295, 787, 1878, 2129, 1102, 840, 2482, 5168, 2037, 3572, 3818, 2032, 1135), _mm256_set_epi16(26292, 27329, 18875, 13987, 4797, 11446, 12976, 6716, 5120, 15127, 31497, 12415, 21770, 23269, 12384, 6917)];

    // Layer 5
    for i in 0..8{
        [a0[i], a0[i+8]] = barrett_butterfly_10753(a[i], a[i+8], l5[0], l5[1]);
    }
    // Layer 6
    for i in 0..4{
        [a1[i], a1[i+4]] = barrett_butterfly_10753(a0[i], a0[i+4], l6[0], l6[1]);
        [a1[i+8], a1[i+12]] = barrett_butterfly_10753(a0[i+8], a0[i+12], l6[2], l6[3]);
    }
    // Layer 7
    for i in 0..4{
        for j in 0..2{
            [a0[i*4+j], a0[i*4+j+2]] = barrett_butterfly_10753(a1[i*4+j], a1[i*4+j+2], l7[2*i], l7[2*i+1]);
        }
    }
    // Layer 8
    for i in 0..8{
        [a1[i*2], a1[i*2+1]] = barrett_butterfly_10753(a0[i*2], a0[i*2+1], l8[2*i], l8[2*i+1]);     
    }
    a1
}

#[target_feature(enable = "avx2")]
pub unsafe fn ntt_11777(s0: [__m256i;16]) -> [__m256i;16]{
    let s1 = ntt1234_11777(s0);
    let s2 = transpose(s1);
    let s3 = ntt5678_11777(s2);
    s3
}

#[target_feature(enable = "avx2")]
pub unsafe fn ntt1234_11777(a: [__m256i;16]) -> [__m256i;16]{
    let mut a0: [__m256i;16] = [_mm256_setzero_si256(); 16];
    let mut a1: [__m256i;16] = [_mm256_setzero_si256(); 16];
    // let l1 ~ l4
    let l1:[__m256i;2] = [_mm256_set1_epi16(5322), _mm256_set1_epi16(29616)];
    let l2:[__m256i;4] = [_mm256_set1_epi16(4976), _mm256_set1_epi16(27690), _mm256_set1_epi16(4201), _mm256_set1_epi16(23377)];
    let l3:[__m256i;8] = [_mm256_set1_epi16(2497), _mm256_set1_epi16(13895), _mm256_set1_epi16(4578), _mm256_set1_epi16(25475), _mm256_set1_epi16(3410), _mm256_set1_epi16(18976), _mm256_set1_epi16(337), _mm256_set1_epi16(1875)];
    let l4:[__m256i;16] = [_mm256_set1_epi16(1224), _mm256_set1_epi16(6811), _mm256_set1_epi16(1447), _mm256_set1_epi16(8052), _mm256_set1_epi16(1915), _mm256_set1_epi16(10656), _mm256_set1_epi16(4525), _mm256_set1_epi16(25180), _mm256_set1_epi16(293), _mm256_set1_epi16(1630), _mm256_set1_epi16(4782), _mm256_set1_epi16(26611), _mm256_set1_epi16(5692), _mm256_set1_epi16(31675), _mm256_set1_epi16(2380), _mm256_set1_epi16(13244)];

    // Layer 1
    for i in 0..8{
        [a0[i], a0[i+8]] = barrett_butterfly_11777(a[i], a[i+8], l1[0], l1[1]);
    }
    // Layer 2
    for i in 0..4{
        [a1[i], a1[i+4]] = barrett_butterfly_11777(a0[i], a0[i+4], l2[0], l2[1]);
        [a1[i+8], a1[i+12]] = barrett_butterfly_11777(a0[i+8], a0[i+12], l2[2], l2[3]);
    }
    // Layer 3
    for i in 0..4{
        for j in 0..2{
            [a0[i*4+j], a0[i*4+j+2]] = barrett_butterfly_11777(a1[i*4+j], a1[i*4+j+2], l3[2*i], l3[2*i+1]);
        }
    }
    // Layer 4
    for i in 0..8{
        [a1[i*2], a1[i*2+1]] = barrett_butterfly_11777(a0[i*2], a0[i*2+1], l4[2*i], l4[2*i+1]);     
    }
    a1
}

#[target_feature(enable = "avx2")]
pub unsafe fn ntt5678_11777(a: [__m256i;16]) -> [__m256i;16]{
    let mut a0: [__m256i;16] = [_mm256_setzero_si256(); 16];
    let mut a1: [__m256i;16] = [_mm256_setzero_si256(); 16];
    // let l5 ~ l8
    let l5:[__m256i;2] = [_mm256_set_epi16(5020, 5573, 3587, 503, 4633, 4212, 4148, 5558, 2469, 3114, 3268, 2333, 1265, 4114, 2838, 5722), _mm256_set_epi16(27935, 31012, 19961, 2799, 25781, 23439, 23083, 30929, 13739, 17329, 18186, 12983, 7039, 22893, 15793, 31841)];
    let l6:[__m256i;4] = [_mm256_set_epi16(690, 1548, 3010, 3488, 2326, 3384, 5197, 2020, 1352, 3238, 3679, 4055, 309, 2639, 5537, 5709), _mm256_set_epi16(3840, 8614, 16750, 19410, 12944, 18831, 28920, 11241, 7524, 18019, 20473, 22565, 1720, 14685, 30812, 31769), _mm256_set_epi16(2244, 5444, 2500, 2584, 1345, 2615, 5739, 1961, 403, 2885, 5513, 5246, 4282, 5203, 1860, 1362), _mm256_set_epi16(12487, 30294, 13912, 14379, 7485, 14552, 31936, 10912, 2243, 16054, 30678, 29193, 23828, 28953, 10350, 7579)];
    let l7:[__m256i;8] = [_mm256_set_epi16(2315, 3560, 1936, 4697, 4748, 1596, 5680, 576, 3062, 4779, 2403, 2562, 5039, 347, 4302, 1470), _mm256_set_epi16(12882, 19810, 10773, 26138, 26421, 8881, 31608, 3205, 17039, 26594, 13372, 14257, 28041, 1931, 23940, 8180), _mm256_set_epi16(1688, 2873, 1483, 5137, 4586, 2695, 2599, 3452, 3404, 4482, 1056, 2802, 1329, 2255, 756, 3412), _mm256_set_epi16(9393, 15988, 8253, 28586, 25520, 14997, 14463, 19209, 18942, 24941, 5876, 15592, 7396, 12548, 4207, 18987), _mm256_set_epi16(2487, 1230, 50, 5073, 1386, 3998, 1478, 5491, 2978, 2541, 2114, 5798, 5570, 2601, 3834, 4322), _mm256_set_epi16(13840, 6845, 278, 28230, 7713, 22248, 8225, 30556, 16572, 14140, 11764, 32264, 30996, 14474, 21335, 24051), _mm256_set_epi16(1534, 1952, 4771, 5622, 3890, 3683, 1120, 4365, 2926, 3206, 3673, 1216, 831, 4547, 4993, 1203), _mm256_set_epi16(8536, 10862, 26549, 31285, 21647, 20495, 6233, 24290, 16282, 17841, 20439, 6767, 4624, 25303, 27785, 6694)];
    let l8:[__m256i;16] = [_mm256_set_epi16(2468, 4727, 44, 3131, 4205, 2550, 4716, 24, 5811, 5518, 409, 856, 4133, 2062, 5713, 2826), _mm256_set_epi16(13734, 26305, 245, 17423, 23400, 14190, 26243, 134, 32337, 30706, 2276, 4763, 22999, 11475, 31791, 15726), _mm256_set_epi16(3341, 1422, 1372, 1273, 2710, 3996, 1765, 1819, 260, 5042, 2047, 2067, 3610, 2200, 3628, 743), _mm256_set_epi16(18592, 7913, 7635, 7084, 15080, 22237, 9822, 10122, 1447, 28057, 11391, 11502, 20089, 12242, 20189, 4135), _mm256_set_epi16(2643, 2105, 3588, 1578, 295, 4971, 3002, 1654, 1710, 3982, 1233, 4071, 3166, 5410, 1790, 438), _mm256_set_epi16(14708, 11714, 19966, 8781, 1642, 27662, 16705, 9204, 9516, 22159, 6861, 22654, 17618, 30105, 9961, 2437), _mm256_set_epi16(4308, 2883, 4819, 1115, 3649, 4520, 4745, 5169, 3001, 5381, 2237, 3818, 3435, 2745, 1213, 810), _mm256_set_epi16(23973, 16043, 26817, 6205, 20306, 25153, 26405, 28764, 16700, 29944, 12448, 21246, 19115, 15275, 6750, 4507), _mm256_set_epi16(4451, 3104, 1223, 1109, 5199, 4007, 5822, 599, 5181, 644, 5004, 5795, 3539, 51, 2603, 3074), _mm256_set_epi16(24769, 17273, 6806, 6171, 28931, 22298, 32398, 3333, 28831, 3584, 27846, 32248, 19694, 284, 14485, 17106), _mm256_set_epi16(4675, 3643, 3875, 1821, 4905, 2893, 603, 3689, 3325, 261, 3491, 2973, 3135, 551, 3414, 1575), _mm256_set_epi16(26015, 20272, 21563, 10133, 27295, 16099, 3356, 20528, 18503, 1452, 19427, 16544, 17445, 3066, 18998, 8764), _mm256_set_epi16(3225, 2765, 3051, 5029, 3845, 4074, 2607, 1043, 1485, 1200, 3326, 5824, 3449, 5318, 5630, 2099), _mm256_set_epi16(17946, 15387, 16978, 27985, 21396, 22671, 14507, 5804, 8264, 6678, 18508, 32409, 19193, 29593, 31330, 11680), _mm256_set_epi16(4361, 5857, 3061, 4783, 5336, 371, 1148, 3879, 803, 3266, 141, 1736, 4765, 2265, 2172, 5495), _mm256_set_epi16(24268, 32593, 17034, 26616, 29693, 2065, 6388, 21586, 4468, 18174, 785, 9660, 26516, 12604, 12087, 30578)];

    // Layer 5
    for i in 0..8{
        [a0[i], a0[i+8]] = barrett_butterfly_11777(a[i], a[i+8], l5[0], l5[1]);
    }
    // Layer 6
    for i in 0..4{
        [a1[i], a1[i+4]] = barrett_butterfly_11777(a0[i], a0[i+4], l6[0], l6[1]);
        [a1[i+8], a1[i+12]] = barrett_butterfly_11777(a0[i+8], a0[i+12], l6[2], l6[3]);
    }
    // Layer 7
    for i in 0..4{
        for j in 0..2{
            [a0[i*4+j], a0[i*4+j+2]] = barrett_butterfly_11777(a1[i*4+j], a1[i*4+j+2], l7[2*i], l7[2*i+1]);
        }
    }
    // Layer 8
    for i in 0..8{
        [a1[i*2], a1[i*2+1]] = barrett_butterfly_11777(a0[i*2], a0[i*2+1], l8[2*i], l8[2*i+1]);     
    }
    a1
}

#[target_feature(enable = "avx2")]
pub unsafe fn ntt_12289(s0: [__m256i;16]) -> [__m256i;16]{
    let s1 = ntt1234_12289(s0);
    let s2 = transpose(s1);
    let s3 = ntt5678_12289(s2);
    s3
}

#[target_feature(enable = "avx2")]
pub unsafe fn ntt1234_12289(a: [__m256i;16]) -> [__m256i;16]{
    let mut a0: [__m256i;16] = [_mm256_setzero_si256(); 16];
    let mut a1: [__m256i;16] = [_mm256_setzero_si256(); 16];
    // let l1 ~ l4
    let l1:[__m256i;2] = [_mm256_set1_epi16(1479), _mm256_set1_epi16(7887)];
    let l2:[__m256i;4] = [_mm256_set1_epi16(4043), _mm256_set1_epi16(21561), _mm256_set1_epi16(5146), _mm256_set1_epi16(27443)];
    let l3:[__m256i;8] = [_mm256_set1_epi16(5736), _mm256_set1_epi16(30590), _mm256_set1_epi16(4134), _mm256_set1_epi16(22046), _mm256_set1_epi16(722), _mm256_set1_epi16(3850), _mm256_set1_epi16(1305), _mm256_set1_epi16(6959)];
    let l4:[__m256i;16] = [_mm256_set1_epi16(1646), _mm256_set1_epi16(8778), _mm256_set1_epi16(1212), _mm256_set1_epi16(6463), _mm256_set1_epi16(5860), _mm256_set1_epi16(31251), _mm256_set1_epi16(3195), _mm256_set1_epi16(17039), _mm256_set1_epi16(2545), _mm256_set1_epi16(13572), _mm256_set1_epi16(3621), _mm256_set1_epi16(19310), _mm256_set1_epi16(3504), _mm256_set1_epi16(18686), _mm256_set1_epi16(3542), _mm256_set1_epi16(18889)];

    // Layer 1
    for i in 0..8{
        [a0[i], a0[i+8]] = barrett_butterfly_12289(a[i], a[i+8], l1[0], l1[1]);
    }
    // Layer 2
    for i in 0..4{
        [a1[i], a1[i+4]] = barrett_butterfly_12289(a0[i], a0[i+4], l2[0], l2[1]);
        [a1[i+8], a1[i+12]] = barrett_butterfly_12289(a0[i+8], a0[i+12], l2[2], l2[3]);
    }
    // Layer 3
    for i in 0..4{
        for j in 0..2{
            [a0[i*4+j], a0[i*4+j+2]] = barrett_butterfly_12289(a1[i*4+j], a1[i*4+j+2], l3[2*i], l3[2*i+1]);
        }
    }
    // Layer 4
    for i in 0..8{
        [a1[i*2], a1[i*2+1]] = barrett_butterfly_12289(a0[i*2], a0[i*2+1], l4[2*i], l4[2*i+1]);     
    }
    a1
}

#[target_feature(enable = "avx2")]
pub unsafe fn ntt5678_12289(a: [__m256i;16]) -> [__m256i;16]{
    let mut a0: [__m256i;16] = [_mm256_setzero_si256(); 16];
    let mut a1: [__m256i;16] = [_mm256_setzero_si256(); 16];
    // let l5 ~ l8
    let l5:[__m256i;2] = [_mm256_set_epi16(2639, 4821, 2625, 949, 2744, 3006, 563, 2975, 5777, 3328, 1351, 4978, 5828, 5023, 5728, 4591), _mm256_set_epi16(14074, 25710, 13999, 5061, 14633, 16031, 3002, 15865, 30808, 17748, 7205, 26547, 31080, 26787, 30547, 24483)];
    let l6:[__m256i;4] = [_mm256_set_epi16(955, 1170, 3014, 1326, 2294, 3553, 2747, 3712, 2768, 4255, 4611, 1853, 3051, 2963, 3091, 1000), _mm256_set_epi16(5093, 6239, 16073, 7071, 12234, 18948, 14649, 19796, 14761, 22691, 24590, 9882, 16271, 15801, 16484, 5333), _mm256_set_epi16(790, 2319, 3201, 5086, 1062, 4805, 4846, 3135, 1635, 1177, 726, 140, 2366, 4896, 81, 4320), _mm256_set_epi16(4213, 12367, 17071, 27123, 5664, 25625, 25843, 16719, 8719, 6277, 3872, 747, 12618, 26110, 432, 23038)];
    let l7:[__m256i;8] = [_mm256_set_epi16(334, 5755, 729, 2089, 5911, 5542, 3707, 2548, 5067, 5767, 130, 2396, 3584, 4278, 2842, 544), _mm256_set_epi16(1781, 30691, 3888, 11140, 31523, 29555, 19769, 13588, 27022, 30755, 693, 12778, 19113, 22814, 15156, 2901), _mm256_set_epi16(2426, 4632, 3241, 5092, 4890, 145, 1759, 4231, 2197, 827, 4354, 4452, 4177, 1673, 480, 5791), _mm256_set_epi16(12938, 24702, 17284, 27155, 26078, 773, 9381, 22563, 11716, 4410, 23219, 23742, 22276, 8922, 2560, 30883), _mm256_set_epi16(1696, 1260, 3289, 2881, 3932, 3637, 3694, 355, 118, 3748, 5374, 3296, 1381, 4989, 9, 339), _mm256_set_epi16(9045, 6719, 17540, 15364, 20969, 19396, 19700, 1893, 629, 19988, 28659, 17577, 7365, 26606, 48, 1808), _mm256_set_epi16(1428, 4388, 2013, 3284, 2731, 3459, 5179, 3382, 2476, 953, 2837, 3949, 2525, 5331, 1022, 2468), _mm256_set_epi16(7615, 23401, 10735, 17513, 14564, 18446, 27619, 18036, 13204, 5082, 15129, 21060, 13466, 28430, 5450, 13162)];
    let l8:[__m256i;16] = [_mm256_set_epi16(2912, 3778, 27, 545, 1912, 3248, 875, 2187, 4048, 5332, 2178, 3016, 2645, 4057, 3915, 1663), _mm256_set_epi16(15529, 20148, 144, 2906, 10197, 17321, 4666, 11663, 21588, 28435, 11615, 16084, 14106, 21636, 20878, 8869), _mm256_set_epi16(5698, 3833, 3066, 5019, 1378, 1207, 3780, 2566, 2249, 3510, 1544, 243, 4053, 3271, 2166, 1777), _mm256_set_epi16(30387, 20441, 16351, 26766, 7349, 6437, 20158, 13684, 11994, 18718, 8234, 1296, 21614, 17444, 11551, 9477), _mm256_set_epi16(354, 390, 3763, 3704, 435, 1168, 1607, 2422, 1153, 2370, 420, 3000, 2305, 1689, 113, 1426), _mm256_set_epi16(1888, 2080, 20068, 19753, 2320, 6229, 8570, 12916, 6149, 12639, 2240, 15999, 12292, 9007, 603, 7605), _mm256_set_epi16(4861, 773, 1440, 2678, 4337, 5277, 4976, 6039, 2884, 2865, 5559, 671, 5042, 3364, 4919, 4654), _mm256_set_epi16(25923, 4122, 7679, 14282, 23129, 28142, 26537, 32205, 15380, 15279, 29646, 3578, 26888, 17940, 26233, 24819), _mm256_set_epi16(2859, 2401, 5084, 1537, 2381, 1065, 5011, 2987, 5407, 2969, 476, 3136, 5195, 4372, 3, 5291), _mm256_set_epi16(15247, 12804, 27112, 8197, 12698, 5680, 26723, 15929, 28835, 15833, 2538, 16724, 27704, 23315, 16, 28216), _mm256_set_epi16(1045, 442, 1632, 242, 5444, 2143, 1002, 6022, 3186, 3978, 3531, 5191, 2780, 2174, 4437, 2704), _mm256_set_epi16(5573, 2357, 8703, 1291, 29032, 11428, 5344, 32115, 16991, 21214, 18830, 27683, 14825, 11594, 23662, 14420), _mm256_set_epi16(5012, 5101, 1017, 4714, 4096, 404, 4284, 2437, 1630, 2686, 3985, 2399, 1484, 4414, 160, 4938), _mm256_set_epi16(26728, 27203, 5424, 25139, 21844, 2154, 22846, 12996, 8693, 14324, 21252, 12794, 7914, 23539, 853, 26334), _mm256_set_epi16(2481, 1067, 4885, 4143, 493, 4645, 5088, 3646, 2126, 3247, 4905, 3400, 4895, 2847, 3149, 3636), _mm256_set_epi16(13231, 5690, 26051, 22094, 2629, 24771, 27134, 19444, 11338, 17316, 26158, 18132, 26105, 15183, 16793, 19390)];

    // Layer 5
    for i in 0..8{
        [a0[i], a0[i+8]] = barrett_butterfly_12289(a[i], a[i+8], l5[0], l5[1]);
    }
    // Layer 6
    for i in 0..4{
        [a1[i], a1[i+4]] = barrett_butterfly_12289(a0[i], a0[i+4], l6[0], l6[1]);
        [a1[i+8], a1[i+12]] = barrett_butterfly_12289(a0[i+8], a0[i+12], l6[2], l6[3]);
    }
    // Layer 7
    for i in 0..4{
        for j in 0..2{
            [a0[i*4+j], a0[i*4+j+2]] = barrett_butterfly_12289(a1[i*4+j], a1[i*4+j+2], l7[2*i], l7[2*i+1]);
        }
    }
    // Layer 8
    for i in 0..8{
        [a1[i*2], a1[i*2+1]] = barrett_butterfly_12289(a0[i*2], a0[i*2+1], l8[2*i], l8[2*i+1]);     
    }
    a1
}

#[target_feature(enable = "avx2")]
pub unsafe fn ntt_13313(s0: [__m256i;16]) -> [__m256i;16]{
    let s1 = ntt1234_13313(s0);
    let s2 = transpose(s1);
    let s3 = ntt5678_13313(s2);
    s3
}

#[target_feature(enable = "avx2")]
pub unsafe fn ntt1234_13313(a: [__m256i;16]) -> [__m256i;16]{
    let mut a0: [__m256i;16] = [_mm256_setzero_si256(); 16];
    let mut a1: [__m256i;16] = [_mm256_setzero_si256(); 16];
    // let l1 ~ l4
    let l1:[__m256i;2] = [_mm256_set1_epi16(258), _mm256_set1_epi16(1270)];
    let l2:[__m256i;4] = [_mm256_set1_epi16(1455), _mm256_set1_epi16(7163), _mm256_set1_epi16(2626), _mm256_set1_epi16(12927)];
    let l3:[__m256i;8] = [_mm256_set1_epi16(5275), _mm256_set1_epi16(25967), _mm256_set1_epi16(3024), _mm256_set1_epi16(14886), _mm256_set1_epi16(6476), _mm256_set1_epi16(31879), _mm256_set1_epi16(6630), _mm256_set1_epi16(32638)];
    let l4:[__m256i;16] = [_mm256_set1_epi16(1415), _mm256_set1_epi16(6966), _mm256_set1_epi16(5619), _mm256_set1_epi16(27661), _mm256_set1_epi16(4690), _mm256_set1_epi16(23087), _mm256_set1_epi16(1463), _mm256_set1_epi16(7202), _mm256_set1_epi16(5487), _mm256_set1_epi16(27011), _mm256_set1_epi16(4468), _mm256_set1_epi16(21995), _mm256_set1_epi16(4196), _mm256_set1_epi16(20656), _mm256_set1_epi16(4215), _mm256_set1_epi16(20749)];

    // Layer 1
    for i in 0..8{
        [a0[i], a0[i+8]] = barrett_butterfly_13313(a[i], a[i+8], l1[0], l1[1]);
    }
    // Layer 2
    for i in 0..4{
        [a1[i], a1[i+4]] = barrett_butterfly_13313(a0[i], a0[i+4], l2[0], l2[1]);
        [a1[i+8], a1[i+12]] = barrett_butterfly_13313(a0[i+8], a0[i+12], l2[2], l2[3]);
    }
    // Layer 3
    for i in 0..4{
        for j in 0..2{
            [a0[i*4+j], a0[i*4+j+2]] = barrett_butterfly_13313(a1[i*4+j], a1[i*4+j+2], l3[2*i], l3[2*i+1]);
        }
    }
    // Layer 4
    for i in 0..8{
        [a1[i*2], a1[i*2+1]] = barrett_butterfly_13313(a0[i*2], a0[i*2+1], l4[2*i], l4[2*i+1]);     
    }
    a1
}

#[target_feature(enable = "avx2")]
pub unsafe fn ntt5678_13313(a: [__m256i;16]) -> [__m256i;16]{
    let mut a0: [__m256i;16] = [_mm256_setzero_si256(); 16];
    let mut a1: [__m256i;16] = [_mm256_setzero_si256(); 16];
    // let l5 ~ l8
    let l5:[__m256i;2] = [_mm256_set_epi16(1278, 3101, 1152, 4330, 3902, 5072, 4358, 6072, 2651, 4995, 3565, 1173, 2970, 5894, 2198, 5375), _mm256_set_epi16(6291, 15265, 5671, 21315, 19208, 24968, 21453, 29891, 13050, 24589, 17549, 5774, 14620, 29014, 10820, 26460)];
    let l6:[__m256i;4] = [_mm256_set_epi16(3696, 519, 1478, 6216, 714, 2169, 5608, 1229, 2368, 2627, 1562, 3813, 4630, 3611, 2878, 4156), _mm256_set_epi16(18194, 2555, 7276, 30600, 3515, 10677, 27607, 6050, 11657, 12932, 7689, 18770, 22792, 17776, 14168, 20459), _mm256_set_epi16(4968, 772, 4753, 6168, 2170, 456, 4253, 2430, 1454, 1197, 3606, 1408, 3630, 272, 3004, 6105), _mm256_set_epi16(24456, 3800, 23398, 30363, 10682, 2245, 20936, 11962, 7158, 5892, 17751, 6931, 17869, 1339, 14788, 30053)];
    let l7:[__m256i;8] = [_mm256_set_epi16(4787, 5365, 5675, 743, 2935, 4556, 3248, 3042, 694, 4798, 3534, 3523, 3718, 5449, 1969, 5583), _mm256_set_epi16(23565, 26410, 27936, 3658, 14448, 22428, 15989, 14975, 3416, 23619, 17397, 17343, 18303, 26824, 9693, 27483), _mm256_set_epi16(3063, 382, 280, 5312, 1611, 3904, 735, 631, 5983, 225, 6488, 3650, 708, 5336, 2108, 2610), _mm256_set_epi16(15078, 1880, 1378, 26149, 7930, 19218, 3618, 3106, 29453, 1108, 31939, 17968, 3485, 26268, 10377, 12848), _mm256_set_epi16(3190, 4657, 5303, 2712, 917, 894, 4385, 492, 1437, 5450, 3152, 1137, 5039, 2401, 5150, 3345), _mm256_set_epi16(15703, 22925, 26105, 13350, 4514, 4401, 21586, 2422, 7074, 26829, 15516, 5597, 24806, 11819, 25352, 16466), _mm256_set_epi16(2386, 3336, 3065, 5893, 3048, 4331, 275, 6194, 2018, 5078, 1123, 460, 4612, 6253, 2600, 2335), _mm256_set_epi16(11746, 16422, 15088, 29010, 15004, 21320, 1354, 30491, 9934, 24998, 5528, 2264, 22704, 30782, 12799, 11495)];
    let l8:[__m256i;16] = [_mm256_set_epi16(4994, 604, 3644, 3532, 2288, 5308, 741, 5730, 3625, 4801, 1195, 4282, 6473, 5528, 3231, 534), _mm256_set_epi16(24584, 2973, 17938, 17387, 11263, 26130, 3648, 28207, 17845, 23634, 5883, 21079, 31865, 27213, 15905, 2629), _mm256_set_epi16(2909, 3924, 5071, 5972, 4532, 1775, 4796, 597, 3340, 549, 2111, 223, 5909, 1733, 5121, 4642), _mm256_set_epi16(14320, 19317, 24963, 29398, 22310, 8738, 23609, 2939, 16442, 2703, 10392, 1098, 29088, 8531, 25209, 22851), _mm256_set_epi16(939, 1857, 2903, 242, 4125, 1600, 2168, 3290, 2427, 15, 5278, 174, 5924, 5358, 1616, 4816), _mm256_set_epi16(4622, 9141, 14291, 1191, 20306, 7876, 10672, 16196, 11947, 74, 25982, 857, 29162, 26376, 7955, 23708), _mm256_set_epi16(2628, 162, 3446, 4129, 790, 97, 198, 3212, 455, 3870, 3798, 4953, 2603, 2188, 4225, 4419), _mm256_set_epi16(12937, 797, 16964, 20326, 3889, 478, 975, 15812, 2240, 19051, 18696, 24382, 12814, 10771, 20798, 21753), _mm256_set_epi16(3867, 4293, 5405, 6413, 5933, 4086, 333, 4149, 3785, 5421, 6576, 6344, 3489, 49, 4080, 3196), _mm256_set_epi16(19036, 21133, 26607, 31569, 29206, 20114, 1639, 20424, 18632, 26686, 32372, 31230, 17175, 241, 20085, 15733), _mm256_set_epi16(789, 2615, 3375, 3742, 281, 2461, 6036, 5402, 4681, 753, 5857, 747, 5122, 671, 913, 838), _mm256_set_epi16(3884, 12873, 16614, 18421, 1383, 12115, 29713, 26592, 23043, 3707, 28832, 3677, 25214, 3303, 4494, 4125), _mm256_set_epi16(3077, 2518, 1872, 407, 3848, 5781, 4200, 5240, 5401, 3949, 3967, 4611, 2770, 4456, 2885, 5506), _mm256_set_epi16(15147, 12395, 9215, 2004, 18943, 28458, 20675, 25795, 26588, 19440, 19528, 22699, 13636, 21936, 14202, 27104), _mm256_set_epi16(4914, 2693, 3708, 1498, 5691, 442, 5247, 6006, 4407, 6259, 1615, 4781, 4242, 4730, 1198, 3943), _mm256_set_epi16(24190, 13257, 18253, 7374, 28015, 2176, 25829, 29566, 21694, 30811, 7950, 23535, 20882, 23284, 5897, 19410)];

    // Layer 5
    for i in 0..8{
        [a0[i], a0[i+8]] = barrett_butterfly_13313(a[i], a[i+8], l5[0], l5[1]);
    }
    // Layer 6
    for i in 0..4{
        [a1[i], a1[i+4]] = barrett_butterfly_13313(a0[i], a0[i+4], l6[0], l6[1]);
        [a1[i+8], a1[i+12]] = barrett_butterfly_13313(a0[i+8], a0[i+12], l6[2], l6[3]);
    }
    // Layer 7
    for i in 0..4{
        for j in 0..2{
            [a0[i*4+j], a0[i*4+j+2]] = barrett_butterfly_13313(a1[i*4+j], a1[i*4+j+2], l7[2*i], l7[2*i+1]);
        }
    }
    // Layer 8
    for i in 0..8{
        [a1[i*2], a1[i*2+1]] = barrett_butterfly_13313(a0[i*2], a0[i*2+1], l8[2*i], l8[2*i+1]);     
    }
    a1
}

#[target_feature(enable = "avx2")]
pub unsafe fn ntt_15361(s0: [__m256i;16]) -> [__m256i;16]{
    let s1 = ntt1234_15361(s0);
    let s2 = transpose(s1);
    let s3 = ntt5678_15361(s2);
    s3
}

#[target_feature(enable = "avx2")]
pub unsafe fn ntt1234_15361(a: [__m256i;16]) -> [__m256i;16]{
    let mut a0: [__m256i;16] = [_mm256_setzero_si256(); 16];
    let mut a1: [__m256i;16] = [_mm256_setzero_si256(); 16];
    // let l1 ~ l4
    let l1:[__m256i;2] = [_mm256_set1_epi16(3968), _mm256_set1_epi16(16929)];
    let l2:[__m256i;4] = [_mm256_set1_epi16(1319), _mm256_set1_epi16(5627), _mm256_set1_epi16(4309), _mm256_set1_epi16(18384)];
    let l3:[__m256i;8] = [_mm256_set1_epi16(179), _mm256_set1_epi16(764), _mm256_set1_epi16(3666), _mm256_set1_epi16(15641), _mm256_set1_epi16(3261), _mm256_set1_epi16(13913), _mm256_set1_epi16(5686), _mm256_set1_epi16(24259)];
    let l4:[__m256i;16] = [_mm256_set1_epi16(3874), _mm256_set1_epi16(16528), _mm256_set1_epi16(4329), _mm256_set1_epi16(18469), _mm256_set1_epi16(5407), _mm256_set1_epi16(23068), _mm256_set1_epi16(4341), _mm256_set1_epi16(18520), _mm256_set1_epi16(6372), _mm256_set1_epi16(27185), _mm256_set1_epi16(110), _mm256_set1_epi16(469), _mm256_set1_epi16(2201), _mm256_set1_epi16(9390), _mm256_set1_epi16(6841), _mm256_set1_epi16(29186)];

    // Layer 1
    for i in 0..8{
        [a0[i], a0[i+8]] = barrett_butterfly_15361(a[i], a[i+8], l1[0], l1[1]);
    }
    // Layer 2
    for i in 0..4{
        [a1[i], a1[i+4]] = barrett_butterfly_15361(a0[i], a0[i+4], l2[0], l2[1]);
        [a1[i+8], a1[i+12]] = barrett_butterfly_15361(a0[i+8], a0[i+12], l2[2], l2[3]);
    }
    // Layer 3
    for i in 0..4{
        for j in 0..2{
            [a0[i*4+j], a0[i*4+j+2]] = barrett_butterfly_15361(a1[i*4+j], a1[i*4+j+2], l3[2*i], l3[2*i+1]);
        }
    }
    // Layer 4
    for i in 0..8{
        [a1[i*2], a1[i*2+1]] = barrett_butterfly_15361(a0[i*2], a0[i*2+1], l4[2*i], l4[2*i+1]);     
    }
    a1
}

#[target_feature(enable = "avx2")]
pub unsafe fn ntt5678_15361(a: [__m256i;16]) -> [__m256i;16]{
    let mut a0: [__m256i;16] = [_mm256_setzero_si256(); 16];
    let mut a1: [__m256i;16] = [_mm256_setzero_si256(); 16];
    // let l5 ~ l8
    let l5:[__m256i;2] = [_mm256_set_epi16(7237, 6707, 6422, 1403, 5361, 2537, 5099, 2395, 7467, 2313, 2572, 5992, 442, 2702, 720, 186), _mm256_set_epi16(30876, 28615, 27399, 5986, 22872, 10824, 21754, 10218, 31857, 9868, 10973, 25564, 1886, 11528, 3072, 794)];
    let l6:[__m256i;4] = [_mm256_set_epi16(2792, 3992, 7145, 4361, 2586, 6349, 2064, 3519, 5184, 2962, 6276, 1535, 4805, 6298, 3937, 5989), _mm256_set_epi16(11912, 17031, 30483, 18606, 11033, 27087, 8806, 15013, 22117, 12637, 26776, 6549, 20500, 26870, 16797, 25551), _mm256_set_epi16(3375, 3065, 5046, 7399, 100, 792, 2539, 243, 1733, 2051, 2987, 7437, 3239, 1883, 121, 885), _mm256_set_epi16(14399, 13076, 21528, 31567, 427, 3379, 10832, 1037, 7394, 8750, 12744, 31729, 13819, 8034, 516, 3776)];
    let l7:[__m256i;8] = [_mm256_set_epi16(3702, 7592, 4435, 7527, 2993, 5938, 2673, 2276, 72, 4377, 2430, 1000, 1210, 3469, 852, 1969), _mm256_set_epi16(15794, 32390, 18921, 32113, 12769, 25334, 11404, 9710, 307, 18674, 10367, 4266, 5162, 14800, 3635, 8401), _mm256_set_epi16(4420, 2135, 5626, 5352, 2171, 1790, 7374, 1100, 6163, 5355, 4468, 4862, 6713, 1536, 1316, 5757), _mm256_set_epi16(18857, 9109, 24003, 22834, 9262, 7637, 31460, 4693, 26294, 22847, 19062, 20743, 28640, 6553, 5615, 24562), _mm256_set_epi16(1860, 1524, 1331, 6772, 10, 1888, 7343, 6649, 2802, 2473, 5279, 7441, 1554, 1668, 11, 1102), _mm256_set_epi16(7935, 6502, 5679, 28892, 43, 8055, 31328, 28367, 11954, 10551, 22522, 31746, 6630, 7116, 47, 4702), _mm256_set_epi16(7200, 5002, 2776, 4907, 6403, 4584, 2793, 6966, 3028, 2815, 5332, 2046, 6511, 1967, 2435, 5149), _mm256_set_epi16(30718, 21340, 11843, 20935, 27318, 19557, 11916, 29720, 12919, 12010, 22748, 8729, 27778, 8392, 10389, 21968)];
    let l8:[__m256i;16] = [_mm256_set_epi16(815, 4885, 5507, 6691, 4522, 3052, 692, 7367, 3046, 7192, 1801, 608, 3741, 3104, 7612, 7535), _mm256_set_epi16(3477, 20841, 23495, 28546, 19293, 13021, 2952, 31430, 12995, 30684, 7684, 2594, 15961, 13243, 32476, 32147), _mm256_set_epi16(7251, 1902, 6927, 6080, 1648, 5868, 3763, 273, 2579, 2882, 3503, 867, 5562, 2850, 4690, 6374), _mm256_set_epi16(30936, 8115, 29553, 25940, 7031, 25035, 16054, 1165, 11003, 12296, 14945, 3699, 23730, 12159, 20009, 27194), _mm256_set_epi16(285, 7056, 3082, 7146, 4450, 2052, 6449, 6784, 6920, 7191, 3204, 3180, 6280, 7211, 5866, 4839), _mm256_set_epi16(1216, 30104, 13149, 30488, 18985, 8755, 27514, 28943, 29523, 30680, 13670, 13567, 26793, 30765, 25027, 20645), _mm256_set_epi16(5834, 4895, 2020, 1078, 7550, 1006, 1794, 6440, 6908, 6850, 5436, 6859, 3498, 4295, 4373, 98), _mm256_set_epi16(24890, 20884, 8618, 4599, 32211, 4292, 7654, 27476, 29472, 29225, 23192, 29263, 14924, 18324, 18657, 418), _mm256_set_epi16(7605, 2516, 1318, 6731, 3133, 5824, 2307, 2353, 7599, 6396, 2764, 863, 2867, 755, 5466, 3003), _mm256_set_epi16(32446, 10734, 5623, 28717, 13367, 24847, 9843, 10039, 32420, 27288, 11792, 3682, 12232, 3221, 23320, 12812), _mm256_set_epi16(7636, 1162, 7084, 4171, 4695, 6688, 980, 2784, 811, 2956, 202, 1119, 6245, 445, 644, 4232), _mm256_set_epi16(32578, 4958, 30223, 17795, 20031, 28534, 4181, 11878, 3460, 12611, 862, 4774, 26644, 1899, 2748, 18055), _mm256_set_epi16(262, 3422, 4308, 469, 2222, 4258, 2296, 817, 5561, 2730, 5301, 1583, 2767, 3237, 4581, 5965), _mm256_set_epi16(1118, 14600, 18380, 2001, 9480, 18166, 9796, 3486, 23725, 11647, 22616, 6754, 11805, 13810, 19544, 25449), _mm256_set_epi16(4932, 628, 2649, 2311, 318, 1356, 1455, 685, 7652, 3135, 5159, 1305, 3659, 2620, 5345, 2181), _mm256_set_epi16(21042, 2679, 11302, 9860, 1357, 5785, 6208, 2922, 32646, 13375, 22010, 5568, 15611, 11178, 22804, 9305)];

    // Layer 5
    for i in 0..8{
        [a0[i], a0[i+8]] = barrett_butterfly_15361(a[i], a[i+8], l5[0], l5[1]);
    }
    // Layer 6
    for i in 0..4{
        [a1[i], a1[i+4]] = barrett_butterfly_15361(a0[i], a0[i+4], l6[0], l6[1]);
        [a1[i+8], a1[i+12]] = barrett_butterfly_15361(a0[i+8], a0[i+12], l6[2], l6[3]);
    }
    // Layer 7
    for i in 0..4{
        for j in 0..2{
            [a0[i*4+j], a0[i*4+j+2]] = barrett_butterfly_15361(a1[i*4+j], a1[i*4+j+2], l7[2*i], l7[2*i+1]);
        }
    }
    // Layer 8
    for i in 0..8{
        [a1[i*2], a1[i*2+1]] = barrett_butterfly_15361(a0[i*2], a0[i*2+1], l8[2*i], l8[2*i+1]);     
    }
    a1
}