use std::arch::x86_64::*;
use crate::field::fields::*;
use crate::ntt::transpose::*;

#[target_feature(enable = "avx2")]
pub unsafe fn ntt_7681(s0: [__m256i;16]) -> [__m256i;16]{
    let s1 = ntt1234_7681(s0);
    let s2 = transpose(s1);
    let s3 = ntt5678_7681(s2);
    s3
}

#[target_feature(enable = "avx2")]
pub unsafe fn ntt1234_7681(a: [__m256i;16]) -> [__m256i;16]{
    let mut a0: [__m256i;16] = [_mm256_setzero_si256(); 16];
    let mut a1: [__m256i;16] = [_mm256_setzero_si256(); 16];
    // let l1 ~ l4
    let l1:[__m256i;2] = [_mm256_set1_epi16(3383), _mm256_set1_epi16(28865)];
    let l2:[__m256i;4] = [_mm256_set1_epi16(1925), _mm256_set1_epi16(16425), _mm256_set1_epi16(1213), _mm256_set1_epi16(10350)];
    let l3:[__m256i;8] = [_mm256_set1_epi16(583), _mm256_set1_epi16(4974), _mm256_set1_epi16(1728), _mm256_set1_epi16(14744), _mm256_set1_epi16(527), _mm256_set1_epi16(4496), _mm256_set1_epi16(849), _mm256_set1_epi16(7244)];
    let l4:[__m256i;16] = [_mm256_set1_epi16(2381), _mm256_set1_epi16(20315), _mm256_set1_epi16(2446), _mm256_set1_epi16(20870), _mm256_set1_epi16(97), _mm256_set1_epi16(828), _mm256_set1_epi16(2132), _mm256_set1_epi16(18191), _mm256_set1_epi16(2784), _mm256_set1_epi16(23754), _mm256_set1_epi16(1366), _mm256_set1_epi16(11655), _mm256_set1_epi16(2138), _mm256_set1_epi16(18242), _mm256_set1_epi16(2648), _mm256_set1_epi16(22593)];

    // Layer 1
    for i in 0..8{
        [a0[i], a0[i+8]] = barrett_butterfly_7681(a[i], a[i+8], l1[0], l1[1]);
    }
    // Layer 2
    for i in 0..4{
        [a1[i], a1[i+4]] = barrett_butterfly_7681(a0[i], a0[i+4], l2[0], l2[1]);
        [a1[i+8], a1[i+12]] = barrett_butterfly_7681(a0[i+8], a0[i+12], l2[2], l2[3]);
    }
    // Layer 3
    for i in 0..4{
        for j in 0..2{
            [a0[i*4+j], a0[i*4+j+2]] = barrett_butterfly_7681(a1[i*4+j], a1[i*4+j+2], l3[2*i], l3[2*i+1]);
        }
    }
    // Layer 4
    for i in 0..8{
        [a1[i*2], a1[i*2+1]] = barrett_butterfly_7681(a0[i*2], a0[i*2+1], l4[2*i], l4[2*i+1]);
    }
    a1
}

#[target_feature(enable = "avx2")]
pub unsafe fn ntt5678_7681(a: [__m256i;16]) -> [__m256i;16]{
    let mut a0: [__m256i;16] = [_mm256_setzero_si256(); 16];
    let mut a1: [__m256i;16] = [_mm256_setzero_si256(); 16];
    // let l5 ~ l8
    let l5:[__m256i;2] = [_mm256_set_epi16(1846, 365, 2753, 3654, 2645, 330, 2273, 878, 3000, 2399, 1112, 1794, 2268, 675, 3092, 1286), _mm256_set_epi16(15750, 3114, 23489, 31177, 22568, 2816, 19394, 7491, 25597, 20469, 9488, 15307, 19351, 5759, 26382, 10972)];
    let l6:[__m256i;4] = [_mm256_set_epi16(2881, 766, 243, 202, 1080, 2516, 3411, 2551, 3449, 528, 2508, 2941, 1655, 584, 2774, 1740), _mm256_set_epi16(24581, 6536, 2073, 1724, 9215, 21467, 29103, 21766, 29428, 4505, 21399, 25093, 14121, 4983, 23668, 14846), _mm256_set_epi16(732, 3074, 3477, 3080, 2469, 3380, 693, 1714, 1382, 2423, 1908, 2724, 1875, 1381, 695, 799), _mm256_set_epi16(6246, 26228, 29667, 26279, 21066, 28839, 5913, 14624, 11792, 20674, 16279, 23242, 15998, 11783, 5930, 6817)];
    let l7:[__m256i;8] = [_mm256_set_epi16(1591, 2028, 2044, 1952, 1097, 1228, 1848, 550, 2681, 1438, 2990, 707, 417, 2593, 1125, 3780), _mm256_set_epi16(13575, 17303, 17440, 16655, 9360, 10478, 15768, 4693, 22875, 12269, 25511, 6032, 3558, 22124, 9599, 32252), _mm256_set_epi16(2722, 993, 1044, 1408, 3041, 2844, 1003, 1853, 2880, 3532, 1415, 1682, 2562, 3078, 648, 3099), _mm256_set_epi16(23225, 8472, 8908, 12013, 25946, 24266, 8558, 15810, 24573, 30136, 12073, 14351, 21860, 26262, 5529, 26441), _mm256_set_epi16(1800, 1633, 1996, 869, 3837, 319, 2897, 405, 3501, 219, 880, 3188, 2900, 2063, 1587, 198), _mm256_set_epi16(15358, 13933, 17030, 7415, 32738, 2722, 24718, 3456, 29871, 1869, 7508, 27201, 24743, 17602, 13541, 1689), _mm256_set_epi16(1402, 3789, 2819, 3125, 3180, 3141, 257, 1478, 1155, 2264, 3566, 3073, 2573, 1886, 1220, 2563), _mm256_set_epi16(11962, 32329, 24052, 26663, 27132, 26800, 2193, 12611, 9855, 19317, 30426, 26220, 21953, 16092, 10409, 21868)];
    let l8:[__m256i;16] = [_mm256_set_epi16(3280, 2805, 118, 218, 335, 3483, 738, 329, 2457, 1189, 113, 1771, 3239, 3250, 1897, 3765), _mm256_set_epi16(27986, 23933, 1007, 1860, 2858, 29718, 6297, 2807, 20964, 10145, 964, 15111, 27636, 27730, 16186, 32124), _mm256_set_epi16(3751, 621, 2811, 535, 1036, 2252, 2760, 3016, 1115, 674, 3376, 639, 3832, 1872, 1211, 2840), _mm256_set_epi16(32004, 5299, 23984, 4565, 8839, 19215, 23549, 25733, 9513, 5751, 28805, 5452, 32695, 15972, 10333, 24232), _mm256_set_epi16(2110, 2481, 1499, 1657, 1717, 1775, 2395, 1170, 2433, 3193, 1885, 1725, 2546, 2717, 572, 536), _mm256_set_epi16(18003, 21168, 12790, 14138, 14650, 15145, 20435, 9983, 20759, 27243, 16083, 14718, 21723, 23182, 4880, 4573), _mm256_set_epi16(1994, 1784, 793, 2050, 3086, 1459, 2671, 3137, 111, 856, 1393, 3615, 3265, 217, 2951, 2067), _mm256_set_epi16(17013, 15221, 6766, 17491, 26330, 12449, 22790, 26766, 947, 7304, 11885, 30844, 27858, 1851, 25179, 17636), _mm256_set_epi16(3694, 185, 2799, 1656, 2358, 3445, 2922, 321, 2583, 2689, 2668, 669, 763, 413, 3799, 1704), _mm256_set_epi16(31518, 1578, 23882, 14129, 20119, 29394, 24931, 2739, 22039, 22943, 22764, 5708, 6510, 3524, 32414, 14539), _mm256_set_epi16(1683, 1968, 1667, 1607, 3626, 201, 1979, 2875, 62, 2359, 1604, 3546, 398, 2259, 1129, 1950), _mm256_set_epi16(14360, 16791, 14223, 13711, 30938, 1715, 16885, 24530, 529, 20128, 13686, 30255, 3396, 19274, 9633, 16638), _mm256_set_epi16(3081, 94, 3394, 1193, 1131, 1035, 2996, 3452, 1266, 3120, 2173, 542, 1437, 702, 1065, 506), _mm256_set_epi16(26288, 802, 28958, 10179, 9650, 8831, 25563, 29453, 10802, 26621, 18541, 4624, 12261, 5990, 9087, 4317), _mm256_set_epi16(3139, 3586, 2372, 2169, 1959, 1406, 2838, 296, 346, 3006, 2757, 2197, 1230, 2012, 2002, 1876), _mm256_set_epi16(26783, 30597, 20238, 18506, 16715, 11996, 24214, 2526, 2952, 25648, 23523, 18745, 10495, 17167, 17082, 16006)];

    // Layer 5
    for i in 0..8{
        [a0[i], a0[i+8]] = barrett_butterfly_7681(a[i], a[i+8], l5[0], l5[1]);
    }
    // // Layer 6
    // for i in 0..4{
    //     [a1[i], a1[i+4]] = barrett_butterfly_7681(a0[i], a0[i+4], l6[0], l6[1]);
    //     [a1[i+8], a1[i+12]] = barrett_butterfly_7681(a0[i+8], a0[i+12], l6[2], l6[3]);
    // }
    // // Layer 7
    // for i in 0..4{
    //     for j in 0..2{
    //         [a0[i*4+j], a0[i*4+j+2]] = barrett_butterfly_7681(a1[i*4+j], a1[i*4+j+2], l7[2*i], l7[2*i+1]);
    //     }
    // }
    // // Layer 8
    // for i in 0..8{
    //     [a1[i*2], a1[i*2+1]] = barrett_butterfly_7681(a0[i*2], a0[i*2+1], l8[2*i], l8[2*i+1]);
    // }
    a0
}

#[target_feature(enable = "avx2")]
pub unsafe fn ntt_10753(s0: [__m256i;16]) -> [__m256i;16]{
    let s1 = ntt1234_10753(s0);
    let s2 = transpose(s1);
    let s3 = ntt5678_10753(s2);
    s3
}

#[target_feature(enable = "avx2")]
pub unsafe fn ntt1234_10753(a: [__m256i;16]) -> [__m256i;16]{
    let mut a0: [__m256i;16] = [_mm256_setzero_si256(); 16];
    let mut a1: [__m256i;16] = [_mm256_setzero_si256(); 16];
    // let l1 ~ l4
    let l1:[__m256i;2] = [_mm256_set1_epi16(4489), _mm256_set1_epi16(27359)];
    let l2:[__m256i;4] = [_mm256_set1_epi16(67), _mm256_set1_epi16(408), _mm256_set1_epi16(321), _mm256_set1_epi16(1956)];
    let l3:[__m256i;8] = [_mm256_set1_epi16(3422), _mm256_set1_epi16(20856), _mm256_set1_epi16(4679), _mm256_set1_epi16(28517), _mm256_set1_epi16(1656), _mm256_set1_epi16(10093), _mm256_set1_epi16(3461), _mm256_set1_epi16(21094)];
    let l4:[__m256i;16] = [_mm256_set1_epi16(1560), _mm256_set1_epi16(9508), _mm256_set1_epi16(2637), _mm256_set1_epi16(16072), _mm256_set1_epi16(4631), _mm256_set1_epi16(28224), _mm256_set1_epi16(3010), _mm256_set1_epi16(18345), _mm256_set1_epi16(2640), _mm256_set1_epi16(16090), _mm256_set1_epi16(1154), _mm256_set1_epi16(7033), _mm256_set1_epi16(4832), _mm256_set1_epi16(29449), _mm256_set1_epi16(2047), _mm256_set1_epi16(12476)];

    // Layer 1
    for i in 0..8{
        [a0[i], a0[i+8]] = barrett_butterfly_10753(a[i], a[i+8], l1[0], l1[1]);
    }
    // Layer 2
    for i in 0..4{
        [a1[i], a1[i+4]] = barrett_butterfly_10753(a0[i], a0[i+4], l2[0], l2[1]);
        [a1[i+8], a1[i+12]] = barrett_butterfly_10753(a0[i+8], a0[i+12], l2[2], l2[3]);
    }
    // Layer 3
    for i in 0..4{
        for j in 0..2{
            [a0[i*4+j], a0[i*4+j+2]] = barrett_butterfly_10753(a1[i*4+j], a1[i*4+j+2], l3[2*i], l3[2*i+1]);
        }
    }
    // Layer 4
    for i in 0..8{
        [a1[i*2], a1[i*2+1]] = barrett_butterfly_10753(a0[i*2], a0[i*2+1], l4[2*i], l4[2*i+1]);
    }
    a1
}

#[target_feature(enable = "avx2")]
pub unsafe fn ntt5678_10753(a: [__m256i;16]) -> [__m256i;16]{
    let mut a0: [__m256i;16] = [_mm256_setzero_si256(); 16];
    let mut a1: [__m256i;16] = [_mm256_setzero_si256(); 16];
    // let l5 ~ l8
    let l5:[__m256i;2] = [_mm256_set_epi16(1186, 1219, 4351, 4191, 3783, 2900, 746, 4611, 136, 2417, 644, 1641, 1917, 3013, 2436, 597), _mm256_set_epi16(7228, 7429, 26518, 25543, 23056, 17675, 4547, 28103, 829, 14731, 3925, 10001, 11683, 18363, 14847, 3639)];
    let l6:[__m256i;4] = [_mm256_set_epi16(2582, 1136, 841, 946, 3902, 559, 5194, 3362, 94, 2599, 4455, 2085, 5122, 2744, 1047, 922), _mm256_set_epi16(15736, 6924, 5126, 5766, 23781, 3407, 31656, 20490, 573, 15840, 27152, 12707, 31217, 16724, 6381, 5619), _mm256_set_epi16(2353, 3171, 3644, 2603, 3982, 3712, 2031, 1385, 5147, 3314, 753, 3775, 3954, 3697, 3907, 380), _mm256_set_epi16(14341, 19326, 22209, 15864, 24269, 22623, 12378, 8441, 31369, 20198, 4589, 23007, 24098, 22532, 23812, 2316)];
    let l7:[__m256i;8] = [_mm256_set_epi16(4627, 4193, 1828, 1353, 3944, 5178, 2830, 4577, 128, 4683, 2177, 1924, 2135, 3092, 3256, 2857), _mm256_set_epi16(28200, 25555, 11141, 8246, 24037, 31558, 17248, 27895, 780, 28541, 13268, 11726, 13012, 18845, 19844, 17412), _mm256_set_epi16(4098, 2461, 3592, 5012, 1145, 29, 1444, 1943, 2228, 1202, 5263, 1266, 1289, 1207, 339, 5155), _mm256_set_epi16(24976, 14999, 21892, 30546, 6978, 177, 8801, 11842, 13579, 7326, 32076, 7716, 7856, 7356, 2066, 31418), _mm256_set_epi16(4305, 2004, 5232, 1896, 100, 2726, 4053, 159, 5125, 5295, 84, 721, 685, 393, 2883, 4825), _mm256_set_epi16(26238, 12214, 31887, 11555, 609, 16614, 24702, 969, 31235, 32271, 512, 4394, 4175, 2395, 17571, 29407), _mm256_set_epi16(2847, 5134, 2805, 118, 1854, 216, 4818, 3719, 267, 4980, 3617, 317, 1945, 331, 671, 1279), _mm256_set_epi16(17352, 31290, 17096, 719, 11300, 1316, 29364, 22666, 1627, 30351, 22044, 1932, 11854, 2017, 4090, 7795)];
    let l8:[__m256i;16] = [_mm256_set_epi16(2032, 3104, 3645, 3661, 2076, 3687, 290, 697, 1135, 1907, 774, 1267, 2137, 1317, 3390, 2215), _mm256_set_epi16(12384, 18918, 22215, 22313, 12653, 22471, 1767, 4248, 6917, 11623, 4717, 7722, 13024, 8027, 20661, 13500), _mm256_set_epi16(3572, 1985, 3959, 2758, 3226, 2777, 1082, 3258, 3818, 1280, 2266, 264, 1339, 156, 3689, 301), _mm256_set_epi16(21770, 12098, 24129, 16809, 19661, 16925, 6594, 19856, 23269, 7801, 13811, 1609, 8161, 951, 22483, 1834), _mm256_set_epi16(5168, 4931, 2160, 2966, 4209, 1180, 2425, 3789, 2037, 4043, 3310, 2056, 2670, 3965, 3170, 3911), _mm256_set_epi16(31497, 30053, 13164, 18077, 25652, 7192, 14780, 23093, 12415, 24641, 20173, 12531, 16273, 24165, 19320, 23836), _mm256_set_epi16(840, 3543, 815, 2515, 3903, 3930, 5238, 3429, 2482, 1590, 1000, 4999, 1466, 38, 2546, 1445), _mm256_set_epi16(5120, 21593, 4967, 15328, 23788, 23952, 31924, 20899, 15127, 9691, 6095, 30467, 8935, 232, 15517, 8807), _mm256_set_epi16(2129, 2336, 4783, 2854, 2664, 1360, 4313, 5096, 1102, 498, 1107, 1437, 3259, 5182, 3098, 3293), _mm256_set_epi16(12976, 14237, 29151, 17394, 16236, 8289, 26286, 31058, 6716, 3035, 6747, 8758, 19863, 31583, 18881, 20070), _mm256_set_epi16(787, 4894, 1036, 5308, 3298, 2159, 4847, 4864, 1878, 10, 670, 3210, 1961, 3778, 4946, 2351), _mm256_set_epi16(4797, 29827, 6314, 32351, 20100, 13158, 29541, 29644, 11446, 61, 4083, 19564, 11952, 23026, 30144, 14329), _mm256_set_epi16(3097, 1196, 3192, 4861, 4181, 4524, 2024, 549, 2295, 881, 5262, 3223, 4711, 3472, 3800, 3942), _mm256_set_epi16(18875, 7289, 19454, 29626, 25482, 27572, 12336, 3346, 13987, 5369, 32070, 19643, 28712, 21161, 23160, 24025), _mm256_set_epi16(4314, 607, 2343, 1293, 1825, 1361, 5163, 3992, 4484, 940, 1538, 656, 1533, 283, 4819, 2545), _mm256_set_epi16(26292, 3699, 14280, 7880, 11123, 8295, 31467, 24330, 27329, 5729, 9374, 3998, 9343, 1725, 29370, 15511)];

    // Layer 5
    for i in 0..8{
        [a0[i], a0[i+8]] = barrett_butterfly_10753(a[i], a[i+8], l5[0], l5[1]);
    }
    // Layer 6
    for i in 0..4{
        [a1[i], a1[i+4]] = barrett_butterfly_10753(a0[i], a0[i+4], l6[0], l6[1]);
        [a1[i+8], a1[i+12]] = barrett_butterfly_10753(a0[i+8], a0[i+12], l6[2], l6[3]);
    }
    // Layer 7
    for i in 0..4{
        for j in 0..2{
            [a0[i*4+j], a0[i*4+j+2]] = barrett_butterfly_10753(a1[i*4+j], a1[i*4+j+2], l7[2*i], l7[2*i+1]);
        }
    }
    // Layer 8
    for i in 0..8{
        [a1[i*2], a1[i*2+1]] = barrett_butterfly_10753(a0[i*2], a0[i*2+1], l8[2*i], l8[2*i+1]);
    }
    a1
}

#[target_feature(enable = "avx2")]
pub unsafe fn ntt_11777(s0: [__m256i;16]) -> [__m256i;16]{
    let s1 = ntt1234_11777(s0);
    let s2 = transpose(s1);
    let s3 = ntt5678_11777(s2);
    s3
}

#[target_feature(enable = "avx2")]
pub unsafe fn ntt1234_11777(a: [__m256i;16]) -> [__m256i;16]{
    let mut a0: [__m256i;16] = [_mm256_setzero_si256(); 16];
    let mut a1: [__m256i;16] = [_mm256_setzero_si256(); 16];
    // let l1 ~ l4
    let l1:[__m256i;2] = [_mm256_set1_epi16(5322), _mm256_set1_epi16(29616)];
    let l2:[__m256i;4] = [_mm256_set1_epi16(4976), _mm256_set1_epi16(27690), _mm256_set1_epi16(4201), _mm256_set1_epi16(23377)];
    let l3:[__m256i;8] = [_mm256_set1_epi16(2497), _mm256_set1_epi16(13895), _mm256_set1_epi16(4578), _mm256_set1_epi16(25475), _mm256_set1_epi16(3410), _mm256_set1_epi16(18976), _mm256_set1_epi16(337), _mm256_set1_epi16(1875)];
    let l4:[__m256i;16] = [_mm256_set1_epi16(1224), _mm256_set1_epi16(6811), _mm256_set1_epi16(1447), _mm256_set1_epi16(8052), _mm256_set1_epi16(1915), _mm256_set1_epi16(10656), _mm256_set1_epi16(4525), _mm256_set1_epi16(25180), _mm256_set1_epi16(293), _mm256_set1_epi16(1630), _mm256_set1_epi16(4782), _mm256_set1_epi16(26611), _mm256_set1_epi16(5692), _mm256_set1_epi16(31675), _mm256_set1_epi16(2380), _mm256_set1_epi16(13244)];

    // Layer 1
    for i in 0..8{
        [a0[i], a0[i+8]] = barrett_butterfly_11777(a[i], a[i+8], l1[0], l1[1]);
    }
    // Layer 2
    for i in 0..4{
        [a1[i], a1[i+4]] = barrett_butterfly_11777(a0[i], a0[i+4], l2[0], l2[1]);
        [a1[i+8], a1[i+12]] = barrett_butterfly_11777(a0[i+8], a0[i+12], l2[2], l2[3]);
    }
    // Layer 3
    for i in 0..4{
        for j in 0..2{
            [a0[i*4+j], a0[i*4+j+2]] = barrett_butterfly_11777(a1[i*4+j], a1[i*4+j+2], l3[2*i], l3[2*i+1]);
        }
    }
    // Layer 4
    for i in 0..8{
        [a1[i*2], a1[i*2+1]] = barrett_butterfly_11777(a0[i*2], a0[i*2+1], l4[2*i], l4[2*i+1]);
    }
    a1
}

#[target_feature(enable = "avx2")]
pub unsafe fn ntt5678_11777(a: [__m256i;16]) -> [__m256i;16]{
    let mut a0: [__m256i;16] = [_mm256_setzero_si256(); 16];
    let mut a1: [__m256i;16] = [_mm256_setzero_si256(); 16];
    // let l5 ~ l8
    let l5:[__m256i;2] = [_mm256_set_epi16(5020, 5573, 3587, 503, 4633, 4212, 4148, 5558, 2469, 3114, 3268, 2333, 1265, 4114, 2838, 5722), _mm256_set_epi16(27935, 31012, 19961, 2799, 25781, 23439, 23083, 30929, 13739, 17329, 18186, 12983, 7039, 22893, 15793, 31841)];
    let l6:[__m256i;4] = [_mm256_set_epi16(403, 1352, 2885, 3238, 5513, 3679, 5246, 4055, 4282, 309, 5203, 2639, 1860, 5537, 1362, 5709), _mm256_set_epi16(2243, 7524, 16054, 18019, 30678, 20473, 29193, 22565, 23828, 1720, 28953, 14685, 10350, 30812, 7579, 31769), _mm256_set_epi16(2244, 690, 5444, 1548, 2500, 3010, 2584, 3488, 1345, 2326, 2615, 3384, 5739, 5197, 1961, 2020), _mm256_set_epi16(12487, 3840, 30294, 8614, 13912, 16750, 14379, 19410, 7485, 12944, 14552, 18831, 31936, 28920, 10912, 11241)];
    let l7:[__m256i;8] = [_mm256_set_epi16(831, 5570, 1329, 5039, 4547, 2601, 2255, 347, 4993, 3834, 756, 4302, 1203, 4322, 3412, 1470), _mm256_set_epi16(4624, 30996, 7396, 28041, 25303, 14474, 12548, 1931, 27785, 21335, 4207, 23940, 6694, 24051, 18987, 8180), _mm256_set_epi16(2926, 2978, 3404, 3062, 3206, 2541, 4482, 4779, 3673, 2114, 1056, 2403, 1216, 5798, 2802, 2562), _mm256_set_epi16(16282, 16572, 18942, 17039, 17841, 14140, 24941, 26594, 20439, 11764, 5876, 13372, 6767, 32264, 15592, 14257), _mm256_set_epi16(3890, 1386, 4586, 4748, 3683, 3998, 2695, 1596, 1120, 1478, 2599, 5680, 4365, 5491, 3452, 576), _mm256_set_epi16(21647, 7713, 25520, 26421, 20495, 22248, 14997, 8881, 6233, 8225, 14463, 31608, 24290, 30556, 19209, 3205), _mm256_set_epi16(1534, 2487, 1688, 2315, 1952, 1230, 2873, 3560, 4771, 50, 1483, 1936, 5622, 5073, 5137, 4697), _mm256_set_epi16(8536, 13840, 9393, 12882, 10862, 6845, 15988, 19810, 26549, 278, 8253, 10773, 31285, 28230, 28586, 26138)];
    let l8:[__m256i;16] = [_mm256_set_epi16(2172, 5630, 3414, 2603, 1213, 1790, 3628, 5713, 5495, 2099, 1575, 3074, 810, 438, 743, 2826), _mm256_set_epi16(12087, 31330, 18998, 14485, 6750, 9961, 20189, 31791, 30578, 11680, 8764, 17106, 4507, 2437, 4135, 15726), _mm256_set_epi16(4765, 3449, 3135, 3539, 3435, 3166, 3610, 4133, 2265, 5318, 551, 51, 2745, 5410, 2200, 2062), _mm256_set_epi16(26516, 19193, 17445, 19694, 19115, 17618, 20089, 22999, 12604, 29593, 3066, 284, 15275, 30105, 12242, 11475), _mm256_set_epi16(141, 3326, 3491, 5004, 2237, 1233, 2047, 409, 1736, 5824, 2973, 5795, 3818, 4071, 2067, 856), _mm256_set_epi16(785, 18508, 19427, 27846, 12448, 6861, 11391, 2276, 9660, 32409, 16544, 32248, 21246, 22654, 11502, 4763), _mm256_set_epi16(803, 1485, 3325, 5181, 3001, 1710, 260, 5811, 3266, 1200, 261, 644, 5381, 3982, 5042, 5518), _mm256_set_epi16(4468, 8264, 18503, 28831, 16700, 9516, 1447, 32337, 18174, 6678, 1452, 3584, 29944, 22159, 28057, 30706), _mm256_set_epi16(1148, 2607, 603, 5822, 4745, 3002, 1765, 4716, 3879, 1043, 3689, 599, 5169, 1654, 1819, 24), _mm256_set_epi16(6388, 14507, 3356, 32398, 26405, 16705, 9822, 26243, 21586, 5804, 20528, 3333, 28764, 9204, 10122, 134), _mm256_set_epi16(5336, 3845, 4905, 5199, 3649, 295, 2710, 4205, 371, 4074, 2893, 4007, 4520, 4971, 3996, 2550), _mm256_set_epi16(29693, 21396, 27295, 28931, 20306, 1642, 15080, 23400, 2065, 22671, 16099, 22298, 25153, 27662, 22237, 14190), _mm256_set_epi16(3061, 3051, 3875, 1223, 4819, 3588, 1372, 44, 4783, 5029, 1821, 1109, 1115, 1578, 1273, 3131), _mm256_set_epi16(17034, 16978, 21563, 6806, 26817, 19966, 7635, 245, 26616, 27985, 10133, 6171, 6205, 8781, 7084, 17423), _mm256_set_epi16(4361, 3225, 4675, 4451, 4308, 2643, 3341, 2468, 5857, 2765, 3643, 3104, 2883, 2105, 1422, 4727), _mm256_set_epi16(24268, 17946, 26015, 24769, 23973, 14708, 18592, 13734, 32593, 15387, 20272, 17273, 16043, 11714, 7913, 26305)];

    // Layer 5
    for i in 0..8{
        [a0[i], a0[i+8]] = barrett_butterfly_11777(a[i], a[i+8], l5[0], l5[1]);
    }
    // Layer 6
    for i in 0..4{
        [a1[i], a1[i+4]] = barrett_butterfly_11777(a0[i], a0[i+4], l6[0], l6[1]);
        [a1[i+8], a1[i+12]] = barrett_butterfly_11777(a0[i+8], a0[i+12], l6[2], l6[3]);
    }
    // Layer 7
    for i in 0..4{
        for j in 0..2{
            [a0[i*4+j], a0[i*4+j+2]] = barrett_butterfly_11777(a1[i*4+j], a1[i*4+j+2], l7[2*i], l7[2*i+1]);
        }
    }
    // Layer 8
    for i in 0..8{
        [a1[i*2], a1[i*2+1]] = barrett_butterfly_11777(a0[i*2], a0[i*2+1], l8[2*i], l8[2*i+1]);
    }
    a1
}

#[target_feature(enable = "avx2")]
pub unsafe fn ntt_12289(s0: [__m256i;16]) -> [__m256i;16]{
    let s1 = ntt1234_12289(s0);
    let s2 = transpose(s1);
    let s3 = ntt5678_12289(s2);
    s3
}

#[target_feature(enable = "avx2")]
pub unsafe fn ntt1234_12289(a: [__m256i;16]) -> [__m256i;16]{
    let mut a0: [__m256i;16] = [_mm256_setzero_si256(); 16];
    let mut a1: [__m256i;16] = [_mm256_setzero_si256(); 16];
    // let l1 ~ l4
    let l1:[__m256i;2] = [_mm256_set1_epi16(1479), _mm256_set1_epi16(7887)];
    let l2:[__m256i;4] = [_mm256_set1_epi16(4043), _mm256_set1_epi16(21561), _mm256_set1_epi16(5146), _mm256_set1_epi16(27443)];
    let l3:[__m256i;8] = [_mm256_set1_epi16(5736), _mm256_set1_epi16(30590), _mm256_set1_epi16(4134), _mm256_set1_epi16(22046), _mm256_set1_epi16(722), _mm256_set1_epi16(3850), _mm256_set1_epi16(1305), _mm256_set1_epi16(6959)];
    let l4:[__m256i;16] = [_mm256_set1_epi16(1646), _mm256_set1_epi16(8778), _mm256_set1_epi16(1212), _mm256_set1_epi16(6463), _mm256_set1_epi16(5860), _mm256_set1_epi16(31251), _mm256_set1_epi16(3195), _mm256_set1_epi16(17039), _mm256_set1_epi16(2545), _mm256_set1_epi16(13572), _mm256_set1_epi16(3621), _mm256_set1_epi16(19310), _mm256_set1_epi16(3504), _mm256_set1_epi16(18686), _mm256_set1_epi16(3542), _mm256_set1_epi16(18889)];

    // Layer 1
    for i in 0..8{
        [a0[i], a0[i+8]] = barrett_butterfly_12289(a[i], a[i+8], l1[0], l1[1]);
    }
    // Layer 2
    for i in 0..4{
        [a1[i], a1[i+4]] = barrett_butterfly_12289(a0[i], a0[i+4], l2[0], l2[1]);
        [a1[i+8], a1[i+12]] = barrett_butterfly_12289(a0[i+8], a0[i+12], l2[2], l2[3]);
    }
    // Layer 3
    for i in 0..4{
        for j in 0..2{
            [a0[i*4+j], a0[i*4+j+2]] = barrett_butterfly_12289(a1[i*4+j], a1[i*4+j+2], l3[2*i], l3[2*i+1]);
        }
    }
    // Layer 4
    for i in 0..8{
        [a1[i*2], a1[i*2+1]] = barrett_butterfly_12289(a0[i*2], a0[i*2+1], l4[2*i], l4[2*i+1]);
    }
    a1
}

#[target_feature(enable = "avx2")]
pub unsafe fn ntt5678_12289(a: [__m256i;16]) -> [__m256i;16]{
    let mut a0: [__m256i;16] = [_mm256_setzero_si256(); 16];
    let mut a1: [__m256i;16] = [_mm256_setzero_si256(); 16];
    // let l5 ~ l8
    let l5:[__m256i;2] = [_mm256_set_epi16(2639, 4821, 2625, 949, 2744, 3006, 563, 2975, 5777, 3328, 1351, 4978, 5828, 5023, 5728, 4591), _mm256_set_epi16(14074, 25710, 13999, 5061, 14633, 16031, 3002, 15865, 30808, 17748, 7205, 26547, 31080, 26787, 30547, 24483)];
    let l6:[__m256i;4] = [_mm256_set_epi16(1635, 2768, 1177, 4255, 726, 4611, 140, 1853, 2366, 3051, 4896, 2963, 81, 3091, 4320, 1000), _mm256_set_epi16(8719, 14761, 6277, 22691, 3872, 24590, 747, 9882, 12618, 16271, 26110, 15801, 432, 16484, 23038, 5333), _mm256_set_epi16(790, 955, 2319, 1170, 3201, 3014, 5086, 1326, 1062, 2294, 4805, 3553, 4846, 2747, 3135, 3712), _mm256_set_epi16(4213, 5093, 12367, 6239, 17071, 16073, 27123, 7071, 5664, 12234, 25625, 18948, 25843, 14649, 16719, 19796)];
    let l7:[__m256i;8] = [_mm256_set_epi16(2525, 1381, 4177, 3584, 5331, 4989, 1673, 4278, 1022, 9, 480, 2842, 2468, 339, 5791, 544), _mm256_set_epi16(13466, 7365, 22276, 19113, 28430, 26606, 8922, 22814, 5450, 48, 2560, 15156, 13162, 1808, 30883, 2901), _mm256_set_epi16(2476, 118, 2197, 5067, 953, 3748, 827, 5767, 2837, 5374, 4354, 130, 3949, 3296, 4452, 2396), _mm256_set_epi16(13204, 629, 11716, 27022, 5082, 19988, 4410, 30755, 15129, 28659, 23219, 693, 21060, 17577, 23742, 12778), _mm256_set_epi16(2731, 3932, 4890, 5911, 3459, 3637, 145, 5542, 5179, 3694, 1759, 3707, 3382, 355, 4231, 2548), _mm256_set_epi16(14564, 20969, 26078, 31523, 18446, 19396, 773, 29555, 27619, 19700, 9381, 19769, 18036, 1893, 22563, 13588), _mm256_set_epi16(1428, 1696, 2426, 334, 4388, 1260, 4632, 5755, 2013, 3289, 3241, 729, 3284, 2881, 5092, 2089), _mm256_set_epi16(7615, 9045, 12938, 1781, 23401, 6719, 24702, 30691, 10735, 17540, 17284, 3888, 17513, 15364, 27155, 11140)];
    let l8:[__m256i;16] = [_mm256_set_epi16(3149, 160, 4437, 3, 4919, 113, 2166, 3915, 3636, 4938, 2704, 5291, 4654, 1426, 1777, 1663), _mm256_set_epi16(16793, 853, 23662, 16, 26233, 603, 11551, 20878, 19390, 26334, 14420, 28216, 24819, 7605, 9477, 8869), _mm256_set_epi16(4895, 1484, 2780, 5195, 5042, 2305, 4053, 2645, 2847, 4414, 2174, 4372, 3364, 1689, 3271, 4057), _mm256_set_epi16(26105, 7914, 14825, 27704, 26888, 12292, 21614, 14106, 15183, 23539, 11594, 23315, 17940, 9007, 17444, 21636), _mm256_set_epi16(4905, 3985, 3531, 476, 5559, 420, 1544, 2178, 3400, 2399, 5191, 3136, 671, 3000, 243, 3016), _mm256_set_epi16(26158, 21252, 18830, 2538, 29646, 2240, 8234, 11615, 18132, 12794, 27683, 16724, 3578, 15999, 1296, 16084), _mm256_set_epi16(2126, 1630, 3186, 5407, 2884, 1153, 2249, 4048, 3247, 2686, 3978, 2969, 2865, 2370, 3510, 5332), _mm256_set_epi16(11338, 8693, 16991, 28835, 15380, 6149, 11994, 21588, 17316, 14324, 21214, 15833, 15279, 12639, 18718, 28435), _mm256_set_epi16(5088, 4284, 1002, 5011, 4976, 1607, 3780, 875, 3646, 2437, 6022, 2987, 6039, 2422, 2566, 2187), _mm256_set_epi16(27134, 22846, 5344, 26723, 26537, 8570, 20158, 4666, 19444, 12996, 32115, 15929, 32205, 12916, 13684, 11663), _mm256_set_epi16(493, 4096, 5444, 2381, 4337, 435, 1378, 1912, 4645, 404, 2143, 1065, 5277, 1168, 1207, 3248), _mm256_set_epi16(2629, 21844, 29032, 12698, 23129, 2320, 7349, 10197, 24771, 2154, 11428, 5680, 28142, 6229, 6437, 17321), _mm256_set_epi16(4885, 1017, 1632, 5084, 1440, 3763, 3066, 27, 4143, 4714, 242, 1537, 2678, 3704, 5019, 545), _mm256_set_epi16(26051, 5424, 8703, 27112, 7679, 20068, 16351, 144, 22094, 25139, 1291, 8197, 14282, 19753, 26766, 2906), _mm256_set_epi16(2481, 5012, 1045, 2859, 4861, 354, 5698, 2912, 1067, 5101, 442, 2401, 773, 390, 3833, 3778), _mm256_set_epi16(13231, 26728, 5573, 15247, 25923, 1888, 30387, 15529, 5690, 27203, 2357, 12804, 4122, 2080, 20441, 20148)];

    // Layer 5
    for i in 0..8{
        [a0[i], a0[i+8]] = barrett_butterfly_12289(a[i], a[i+8], l5[0], l5[1]);
    }
    // Layer 6
    for i in 0..4{
        [a1[i], a1[i+4]] = barrett_butterfly_12289(a0[i], a0[i+4], l6[0], l6[1]);
        [a1[i+8], a1[i+12]] = barrett_butterfly_12289(a0[i+8], a0[i+12], l6[2], l6[3]);
    }
    // Layer 7
    for i in 0..4{
        for j in 0..2{
            [a0[i*4+j], a0[i*4+j+2]] = barrett_butterfly_12289(a1[i*4+j], a1[i*4+j+2], l7[2*i], l7[2*i+1]);
        }
    }
    // Layer 8
    for i in 0..8{
        [a1[i*2], a1[i*2+1]] = barrett_butterfly_12289(a0[i*2], a0[i*2+1], l8[2*i], l8[2*i+1]);
    }
    a1
}

#[target_feature(enable = "avx2")]
pub unsafe fn ntt_13313(s0: [__m256i;16]) -> [__m256i;16]{
    let s1 = ntt1234_13313(s0);
    let s2 = transpose(s1);
    let s3 = ntt5678_13313(s2);
    s3
}

#[target_feature(enable = "avx2")]
pub unsafe fn ntt1234_13313(a: [__m256i;16]) -> [__m256i;16]{
    let mut a0: [__m256i;16] = [_mm256_setzero_si256(); 16];
    let mut a1: [__m256i;16] = [_mm256_setzero_si256(); 16];
    // let l1 ~ l4
    let l1:[__m256i;2] = [_mm256_set1_epi16(258), _mm256_set1_epi16(1270)];
    let l2:[__m256i;4] = [_mm256_set1_epi16(1455), _mm256_set1_epi16(7163), _mm256_set1_epi16(2626), _mm256_set1_epi16(12927)];
    let l3:[__m256i;8] = [_mm256_set1_epi16(5275), _mm256_set1_epi16(25967), _mm256_set1_epi16(3024), _mm256_set1_epi16(14886), _mm256_set1_epi16(6476), _mm256_set1_epi16(31879), _mm256_set1_epi16(6630), _mm256_set1_epi16(32638)];
    let l4:[__m256i;16] = [_mm256_set1_epi16(1415), _mm256_set1_epi16(6966), _mm256_set1_epi16(5619), _mm256_set1_epi16(27661), _mm256_set1_epi16(4690), _mm256_set1_epi16(23087), _mm256_set1_epi16(1463), _mm256_set1_epi16(7202), _mm256_set1_epi16(5487), _mm256_set1_epi16(27011), _mm256_set1_epi16(4468), _mm256_set1_epi16(21995), _mm256_set1_epi16(4196), _mm256_set1_epi16(20656), _mm256_set1_epi16(4215), _mm256_set1_epi16(20749)];

    // Layer 1
    for i in 0..8{
        [a0[i], a0[i+8]] = barrett_butterfly_13313(a[i], a[i+8], l1[0], l1[1]);
    }
    // Layer 2
    for i in 0..4{
        [a1[i], a1[i+4]] = barrett_butterfly_13313(a0[i], a0[i+4], l2[0], l2[1]);
        [a1[i+8], a1[i+12]] = barrett_butterfly_13313(a0[i+8], a0[i+12], l2[2], l2[3]);
    }
    // Layer 3
    for i in 0..4{
        for j in 0..2{
            [a0[i*4+j], a0[i*4+j+2]] = barrett_butterfly_13313(a1[i*4+j], a1[i*4+j+2], l3[2*i], l3[2*i+1]);
        }
    }
    // Layer 4
    for i in 0..8{
        [a1[i*2], a1[i*2+1]] = barrett_butterfly_13313(a0[i*2], a0[i*2+1], l4[2*i], l4[2*i+1]);
    }
    a1
}

#[target_feature(enable = "avx2")]
pub unsafe fn ntt5678_13313(a: [__m256i;16]) -> [__m256i;16]{
    let mut a0: [__m256i;16] = [_mm256_setzero_si256(); 16];
    let mut a1: [__m256i;16] = [_mm256_setzero_si256(); 16];
    // let l5 ~ l8
    let l5:[__m256i;2] = [_mm256_set_epi16(1278, 3101, 1152, 4330, 3902, 5072, 4358, 6072, 2651, 4995, 3565, 1173, 2970, 5894, 2198, 5375), _mm256_set_epi16(6291, 15265, 5671, 21315, 19208, 24968, 21453, 29891, 13050, 24589, 17549, 5774, 14620, 29014, 10820, 26460)];
    let l6:[__m256i;4] = [_mm256_set_epi16(1454, 2368, 1197, 2627, 3606, 1562, 1408, 3813, 3630, 4630, 272, 3611, 3004, 2878, 6105, 4156), _mm256_set_epi16(7158, 11657, 5892, 12932, 17751, 7689, 6931, 18770, 17869, 22792, 1339, 17776, 14788, 14168, 30053, 20459), _mm256_set_epi16(4968, 3696, 772, 519, 4753, 1478, 6168, 6216, 2170, 714, 456, 2169, 4253, 5608, 2430, 1229), _mm256_set_epi16(24456, 18194, 3800, 2555, 23398, 7276, 30363, 30600, 10682, 3515, 2245, 10677, 20936, 27607, 11962, 6050)];
    let l7:[__m256i;8] = [_mm256_set_epi16(4612, 5039, 708, 3718, 6253, 2401, 5336, 5449, 2600, 5150, 2108, 1969, 2335, 3345, 2610, 5583), _mm256_set_epi16(22704, 24806, 3485, 18303, 30782, 11819, 26268, 26824, 12799, 25352, 10377, 9693, 11495, 16466, 12848, 27483), _mm256_set_epi16(2018, 1437, 5983, 694, 5078, 5450, 225, 4798, 1123, 3152, 6488, 3534, 460, 1137, 3650, 3523), _mm256_set_epi16(9934, 7074, 29453, 3416, 24998, 26829, 1108, 23619, 5528, 15516, 31939, 17397, 2264, 5597, 17968, 17343), _mm256_set_epi16(3048, 917, 1611, 2935, 4331, 894, 3904, 4556, 275, 4385, 735, 3248, 6194, 492, 631, 3042), _mm256_set_epi16(15004, 4514, 7930, 14448, 21320, 4401, 19218, 22428, 1354, 21586, 3618, 15989, 30491, 2422, 3106, 14975), _mm256_set_epi16(2386, 3190, 3063, 4787, 3336, 4657, 382, 5365, 3065, 5303, 280, 5675, 5893, 2712, 5312, 743), _mm256_set_epi16(11746, 15703, 15078, 23565, 16422, 22925, 1880, 26410, 15088, 26105, 1378, 27936, 29010, 13350, 26149, 3658)];
    let l8:[__m256i;16] = [_mm256_set_epi16(1198, 2885, 913, 4080, 4225, 1616, 5121, 3231, 3943, 5506, 838, 3196, 4419, 4816, 4642, 534), _mm256_set_epi16(5897, 14202, 4494, 20085, 20798, 7955, 25209, 15905, 19410, 27104, 4125, 15733, 21753, 23708, 22851, 2629), _mm256_set_epi16(4242, 2770, 5122, 3489, 2603, 5924, 5909, 6473, 4730, 4456, 671, 49, 2188, 5358, 1733, 5528), _mm256_set_epi16(20882, 13636, 25214, 17175, 12814, 29162, 29088, 31865, 23284, 21936, 3303, 241, 10771, 26376, 8531, 27213), _mm256_set_epi16(1615, 3967, 5857, 6576, 3798, 5278, 2111, 1195, 4781, 4611, 747, 6344, 4953, 174, 223, 4282), _mm256_set_epi16(7950, 19528, 28832, 32372, 18696, 25982, 10392, 5883, 23535, 22699, 3677, 31230, 24382, 857, 1098, 21079), _mm256_set_epi16(4407, 5401, 4681, 3785, 455, 2427, 3340, 3625, 6259, 3949, 753, 5421, 3870, 15, 549, 4801), _mm256_set_epi16(21694, 26588, 23043, 18632, 2240, 11947, 16442, 17845, 30811, 19440, 3707, 26686, 19051, 74, 2703, 23634), _mm256_set_epi16(5247, 4200, 6036, 333, 198, 2168, 4796, 741, 6006, 5240, 5402, 4149, 3212, 3290, 597, 5730), _mm256_set_epi16(25829, 20675, 29713, 1639, 975, 10672, 23609, 3648, 29566, 25795, 26592, 20424, 15812, 16196, 2939, 28207), _mm256_set_epi16(5691, 3848, 281, 5933, 790, 4125, 4532, 2288, 442, 5781, 2461, 4086, 97, 1600, 1775, 5308), _mm256_set_epi16(28015, 18943, 1383, 29206, 3889, 20306, 22310, 11263, 2176, 28458, 12115, 20114, 478, 7876, 8738, 26130), _mm256_set_epi16(3708, 1872, 3375, 5405, 3446, 2903, 5071, 3644, 1498, 407, 3742, 6413, 4129, 242, 5972, 3532), _mm256_set_epi16(18253, 9215, 16614, 26607, 16964, 14291, 24963, 17938, 7374, 2004, 18421, 31569, 20326, 1191, 29398, 17387), _mm256_set_epi16(4914, 3077, 789, 3867, 2628, 939, 2909, 4994, 2693, 2518, 2615, 4293, 162, 1857, 3924, 604), _mm256_set_epi16(24190, 15147, 3884, 19036, 12937, 4622, 14320, 24584, 13257, 12395, 12873, 21133, 797, 9141, 19317, 2973)];

    // Layer 5
    for i in 0..8{
        [a0[i], a0[i+8]] = barrett_butterfly_13313(a[i], a[i+8], l5[0], l5[1]);
    }
    // Layer 6
    for i in 0..4{
        [a1[i], a1[i+4]] = barrett_butterfly_13313(a0[i], a0[i+4], l6[0], l6[1]);
        [a1[i+8], a1[i+12]] = barrett_butterfly_13313(a0[i+8], a0[i+12], l6[2], l6[3]);
    }
    // Layer 7
    for i in 0..4{
        for j in 0..2{
            [a0[i*4+j], a0[i*4+j+2]] = barrett_butterfly_13313(a1[i*4+j], a1[i*4+j+2], l7[2*i], l7[2*i+1]);
        }
    }
    // Layer 8
    for i in 0..8{
        [a1[i*2], a1[i*2+1]] = barrett_butterfly_13313(a0[i*2], a0[i*2+1], l8[2*i], l8[2*i+1]);
    }
    a1
}

#[target_feature(enable = "avx2")]
pub unsafe fn ntt_15361(s0: [__m256i;16]) -> [__m256i;16]{
    let s1 = ntt1234_15361(s0);
    let s2 = transpose(s1);
    let s3 = ntt5678_15361(s2);
    s3
}

#[target_feature(enable = "avx2")]
pub unsafe fn ntt1234_15361(a: [__m256i;16]) -> [__m256i;16]{
    let mut a0: [__m256i;16] = [_mm256_setzero_si256(); 16];
    let mut a1: [__m256i;16] = [_mm256_setzero_si256(); 16];
    // let l1 ~ l4
    let l1:[__m256i;2] = [_mm256_set1_epi16(3968), _mm256_set1_epi16(16929)];
    let l2:[__m256i;4] = [_mm256_set1_epi16(1319), _mm256_set1_epi16(5627), _mm256_set1_epi16(4309), _mm256_set1_epi16(18384)];
    let l3:[__m256i;8] = [_mm256_set1_epi16(179), _mm256_set1_epi16(764), _mm256_set1_epi16(3666), _mm256_set1_epi16(15641), _mm256_set1_epi16(3261), _mm256_set1_epi16(13913), _mm256_set1_epi16(5686), _mm256_set1_epi16(24259)];
    let l4:[__m256i;16] = [_mm256_set1_epi16(3874), _mm256_set1_epi16(16528), _mm256_set1_epi16(4329), _mm256_set1_epi16(18469), _mm256_set1_epi16(5407), _mm256_set1_epi16(23068), _mm256_set1_epi16(4341), _mm256_set1_epi16(18520), _mm256_set1_epi16(6372), _mm256_set1_epi16(27185), _mm256_set1_epi16(110), _mm256_set1_epi16(469), _mm256_set1_epi16(2201), _mm256_set1_epi16(9390), _mm256_set1_epi16(6841), _mm256_set1_epi16(29186)];

    // Layer 1
    for i in 0..8{
        [a0[i], a0[i+8]] = barrett_butterfly_15361(a[i], a[i+8], l1[0], l1[1]);
    }
    // Layer 2
    for i in 0..4{
        [a1[i], a1[i+4]] = barrett_butterfly_15361(a0[i], a0[i+4], l2[0], l2[1]);
        [a1[i+8], a1[i+12]] = barrett_butterfly_15361(a0[i+8], a0[i+12], l2[2], l2[3]);
    }
    // Layer 3
    for i in 0..4{
        for j in 0..2{
            [a0[i*4+j], a0[i*4+j+2]] = barrett_butterfly_15361(a1[i*4+j], a1[i*4+j+2], l3[2*i], l3[2*i+1]);
        }
    }
    // Layer 4
    for i in 0..8{
        [a1[i*2], a1[i*2+1]] = barrett_butterfly_15361(a0[i*2], a0[i*2+1], l4[2*i], l4[2*i+1]);
    }
    a1
}

#[target_feature(enable = "avx2")]
pub unsafe fn ntt5678_15361(a: [__m256i;16]) -> [__m256i;16]{
    let mut a0: [__m256i;16] = [_mm256_setzero_si256(); 16];
    let mut a1: [__m256i;16] = [_mm256_setzero_si256(); 16];
    // let l5 ~ l8
    let l5:[__m256i;2] = [_mm256_set_epi16(7237, 6707, 6422, 1403, 5361, 2537, 5099, 2395, 7467, 2313, 2572, 5992, 442, 2702, 720, 186), _mm256_set_epi16(30876, 28615, 27399, 5986, 22872, 10824, 21754, 10218, 31857, 9868, 10973, 25564, 1886, 11528, 3072, 794)];
    let l6:[__m256i;4] = [_mm256_set_epi16(1733, 5184, 2051, 2962, 2987, 6276, 7437, 1535, 3239, 4805, 1883, 6298, 121, 3937, 885, 5989), _mm256_set_epi16(7394, 22117, 8750, 12637, 12744, 26776, 31729, 6549, 13819, 20500, 8034, 26870, 516, 16797, 3776, 25551), _mm256_set_epi16(3375, 2792, 3065, 3992, 5046, 7145, 7399, 4361, 100, 2586, 792, 6349, 2539, 2064, 243, 3519), _mm256_set_epi16(14399, 11912, 13076, 17031, 21528, 30483, 31567, 18606, 427, 11033, 3379, 27087, 10832, 8806, 1037, 15013)];
    let l7:[__m256i;8] = [_mm256_set_epi16(6511, 1554, 6713, 1210, 1967, 1668, 1536, 3469, 2435, 11, 1316, 852, 5149, 1102, 5757, 1969), _mm256_set_epi16(27778, 6630, 28640, 5162, 8392, 7116, 6553, 14800, 10389, 47, 5615, 3635, 21968, 4702, 24562, 8401), _mm256_set_epi16(3028, 2802, 6163, 72, 2815, 2473, 5355, 4377, 5332, 5279, 4468, 2430, 2046, 7441, 4862, 1000), _mm256_set_epi16(12919, 11954, 26294, 307, 12010, 10551, 22847, 18674, 22748, 22522, 19062, 10367, 8729, 31746, 20743, 4266), _mm256_set_epi16(6403, 10, 2171, 2993, 4584, 1888, 1790, 5938, 2793, 7343, 7374, 2673, 6966, 6649, 1100, 2276), _mm256_set_epi16(27318, 43, 9262, 12769, 19557, 8055, 7637, 25334, 11916, 31328, 31460, 11404, 29720, 28367, 4693, 9710), _mm256_set_epi16(7200, 1860, 4420, 3702, 5002, 1524, 2135, 7592, 2776, 1331, 5626, 4435, 4907, 6772, 5352, 7527), _mm256_set_epi16(30718, 7935, 18857, 15794, 21340, 6502, 9109, 32390, 11843, 5679, 24003, 18921, 20935, 28892, 22834, 32113)];
    let l8:[__m256i;16] = [_mm256_set_epi16(5345, 4581, 644, 5466, 4373, 5866, 4690, 7612, 2181, 5965, 4232, 3003, 98, 4839, 6374, 7535), _mm256_set_epi16(22804, 19544, 2748, 23320, 18657, 25027, 20009, 32476, 9305, 25449, 18055, 12812, 418, 20645, 27194, 32147), _mm256_set_epi16(3659, 2767, 6245, 2867, 3498, 6280, 5562, 3741, 2620, 3237, 445, 755, 4295, 7211, 2850, 3104), _mm256_set_epi16(15611, 11805, 26644, 12232, 14924, 26793, 23730, 15961, 11178, 13810, 1899, 3221, 18324, 30765, 12159, 13243), _mm256_set_epi16(5159, 5301, 202, 2764, 5436, 3204, 3503, 1801, 1305, 1583, 1119, 863, 6859, 3180, 867, 608), _mm256_set_epi16(22010, 22616, 862, 11792, 23192, 13670, 14945, 7684, 5568, 6754, 4774, 3682, 29263, 13567, 3699, 2594), _mm256_set_epi16(7652, 5561, 811, 7599, 6908, 6920, 2579, 3046, 3135, 2730, 2956, 6396, 6850, 7191, 2882, 7192), _mm256_set_epi16(32646, 23725, 3460, 32420, 29472, 29523, 11003, 12995, 13375, 11647, 12611, 27288, 29225, 30680, 12296, 30684), _mm256_set_epi16(1455, 2296, 980, 2307, 1794, 6449, 3763, 692, 685, 817, 2784, 2353, 6440, 6784, 273, 7367), _mm256_set_epi16(6208, 9796, 4181, 9843, 7654, 27514, 16054, 2952, 2922, 3486, 11878, 10039, 27476, 28943, 1165, 31430), _mm256_set_epi16(318, 2222, 4695, 3133, 7550, 4450, 1648, 4522, 1356, 4258, 6688, 5824, 1006, 2052, 5868, 3052), _mm256_set_epi16(1357, 9480, 20031, 13367, 32211, 18985, 7031, 19293, 5785, 18166, 28534, 24847, 4292, 8755, 25035, 13021), _mm256_set_epi16(2649, 4308, 7084, 1318, 2020, 3082, 6927, 5507, 2311, 469, 4171, 6731, 1078, 7146, 6080, 6691), _mm256_set_epi16(11302, 18380, 30223, 5623, 8618, 13149, 29553, 23495, 9860, 2001, 17795, 28717, 4599, 30488, 25940, 28546), _mm256_set_epi16(4932, 262, 7636, 7605, 5834, 285, 7251, 815, 628, 3422, 1162, 2516, 4895, 7056, 1902, 4885), _mm256_set_epi16(21042, 1118, 32578, 32446, 24890, 1216, 30936, 3477, 2679, 14600, 4958, 10734, 20884, 30104, 8115, 20841)];

    // Layer 5
    for i in 0..8{
        [a0[i], a0[i+8]] = barrett_butterfly_15361(a[i], a[i+8], l5[0], l5[1]);
    }
    // Layer 6
    for i in 0..4{
        [a1[i], a1[i+4]] = barrett_butterfly_15361(a0[i], a0[i+4], l6[0], l6[1]);
        [a1[i+8], a1[i+12]] = barrett_butterfly_15361(a0[i+8], a0[i+12], l6[2], l6[3]);
    }
    // Layer 7
    for i in 0..4{
        for j in 0..2{
            [a0[i*4+j], a0[i*4+j+2]] = barrett_butterfly_15361(a1[i*4+j], a1[i*4+j+2], l7[2*i], l7[2*i+1]);
        }
    }
    // Layer 8
    for i in 0..8{
        [a1[i*2], a1[i*2+1]] = barrett_butterfly_15361(a0[i*2], a0[i*2+1], l8[2*i], l8[2*i+1]);
    }
    a1
}